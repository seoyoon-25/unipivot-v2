# 프로그램 날짜 동기화 스크립트

기존 사이트(unipivot.org)의 프로그램 날짜 정보를 새 사이트(bestcome.org)에 자동으로 동기화하는 스크립트입니다.

## 📋 개요

이 스크립트는 다음 기능을 제공합니다:

- **자동 매칭**: 프로그램 제목을 기반으로 두 사이트의 프로그램을 자동 매칭
- **날짜 동기화**: 모집 기간, 진행 기간 등 날짜 정보 복사
- **안전한 실행**: 자동 백업 및 복구 지원
- **테스트 모드**: 실제 변경 없이 미리 확인 가능

## 📁 파일 구조

```
scripts/
├── .env.example          # 환경변수 템플릿
├── .env                  # 실제 환경변수 (직접 생성)
├── db-connection.js      # 데이터베이스 연결 유틸리티
├── string-matcher.js     # 문자열 매칭 알고리즘
├── backup-utility.js     # 백업/복구 유틸리티
├── sync-program-dates.js # 메인 동기화 스크립트
└── README.md             # 이 문서
```

## 🚀 시작하기

### 1. 사전 준비

- Node.js 18 이상
- 두 데이터베이스에 대한 접속 권한
- Prisma Client 설치 (`pnpm install`)

### 2. 환경 설정

```bash
# .env 파일 생성
cp scripts/.env.example scripts/.env

# .env 파일 편집
nano scripts/.env
```

**.env 파일 내용:**

```env
# 기존 데이터베이스 (unipivot.org)
OLD_DATABASE_URL=postgresql://user:password@host:5432/old_database

# 새 데이터베이스 (bestcome.org)
NEW_DATABASE_URL=postgresql://user:password@host:5432/new_database

# Dry-run 모드 (true: 테스트만)
DRY_RUN=true
```

### 3. 테스트 실행 (권장)

실제 데이터를 변경하기 전에 먼저 테스트 모드로 실행하세요:

```bash
# 방법 1: npm 스크립트 사용
npm run sync:dry-run

# 방법 2: 직접 실행
node scripts/sync-program-dates.js --dry-run
```

### 4. 실제 실행

테스트 결과가 만족스러우면 실제로 실행합니다:

```bash
# 방법 1: npm 스크립트 사용
npm run sync:run

# 방법 2: 직접 실행
node scripts/sync-program-dates.js
```

## 📖 사용법

### 기본 명령어

```bash
# 테스트 모드 (실제 변경 없음)
node scripts/sync-program-dates.js --dry-run

# 실제 실행 (자동 백업 생성)
node scripts/sync-program-dates.js

# 백업에서 복구
node scripts/sync-program-dates.js --restore

# 도움말
node scripts/sync-program-dates.js --help
```

### npm 스크립트

```bash
npm run sync:dry-run    # 테스트 모드
npm run sync:run        # 실제 실행
npm run sync:restore    # 백업 복구
```

### 옵션

| 옵션 | 설명 | 기본값 |
|------|------|--------|
| `--dry-run` | 테스트 모드 (실제 변경 없음) | - |
| `--restore` | 백업에서 복구 | - |
| `--verbose`, `-v` | 상세 로깅 | - |
| `--threshold=N` | 매칭 임계값 (0.0~1.0) | 0.85 |
| `--help`, `-h` | 도움말 표시 | - |

## 🔧 동작 원리

### 1. 매칭 알고리즘

프로그램 제목을 비교하여 자동으로 매칭합니다:

1. **문자열 정규화**: 공백, 특수문자 제거, 소문자 변환
2. **유사도 계산**: Levenshtein distance 기반 유사도 측정
3. **임계값 적용**: 기본 85% 이상 유사한 경우 매칭

예시:
```
"[시즌1] 남북한걸음 독서모임"
    ↓ 매칭 (92%)
"시즌1 남북한걸음 독서모임 회원모집"
```

### 2. 동기화 필드

다음 필드가 동기화됩니다:

| 필드 | 설명 |
|------|------|
| `recruitStartDate` | 모집 시작일 |
| `recruitEndDate` | 모집 종료일 |
| `startDate` | 프로그램 시작일 |
| `endDate` | 프로그램 종료일 |
| `status` | 상태 |

### 3. 백업 시스템

- 실제 실행 시 자동으로 백업 테이블 생성
- 백업 테이블명: `Program_backup_YYYY-MM-DDTHH-MM-SS`
- 최대 5개 백업 유지 (오래된 것 자동 삭제)

## ⚠️ 문제 해결

### 연결 오류

```
❌ 기존 DB 연결 실패
```

**해결방법:**
1. `.env` 파일의 DATABASE_URL 확인
2. 데이터베이스 서버 실행 상태 확인
3. 방화벽 설정 확인
4. 사용자 권한 확인

### 매칭 실패

```
❌ 매칭 실패: "프로그램 제목"
```

**해결방법:**
1. 제목이 너무 다른 경우: 수동으로 매칭 필요
2. 임계값 조정: `--threshold=0.70` 옵션 사용
3. 새 사이트에 해당 프로그램이 없는 경우

### 업데이트 실패

```
❌ 업데이트 실패: foreign key constraint
```

**해결방법:**
1. 관련 테이블의 데이터 확인
2. 외래 키 제약 조건 확인
3. 필요시 관련 데이터 먼저 정리

### 복구 필요

문제 발생 시 백업에서 복구:

```bash
node scripts/sync-program-dates.js --restore
```

## 📊 출력 예시

### 테스트 모드 출력

```
============================================================
🚀 프로그램 날짜 동기화
============================================================

🔍 DRY-RUN 모드: 실제 업데이트 없이 확인만 합니다.

1️⃣  데이터베이스 연결 테스트
----------------------------------------
✅ 기존 DB 연결 성공 (프로그램 60개)
✅ 새 DB 연결 성공 (프로그램 60개)

2️⃣  기존 사이트 프로그램 조회
----------------------------------------
✅ 60개 프로그램 찾음

3️⃣  새 사이트 프로그램 조회
----------------------------------------
✅ 60개 프로그램 찾음

4️⃣  매칭 및 업데이트
----------------------------------------
✅ 완전 일치: "[시즌1] 남북한걸음 독서모임..."
   🔍 [DRY-RUN] 업데이트 건너뜀
...

============================================================
📊 동기화 결과 리포트
============================================================

📈 통계
----------------------------------------
   전체 프로그램:    60개
   매칭 성공:        58개
   업데이트 완료:    55개
   건너뜀 (날짜없음): 3개
   실패:             2개
   매칭 실패:        2개

   📊 매칭률: 96.7%

============================================================
✅ 동기화 완료!
============================================================
```

## 🔒 보안 주의사항

1. **환경변수 파일 보호**
   - `.env` 파일을 Git에 커밋하지 마세요
   - `.gitignore`에 `.env` 추가

2. **데이터베이스 권한**
   - 최소 필요 권한만 부여
   - 프로덕션 환경에서는 별도 사용자 사용

3. **백업 확인**
   - 실행 전 백업 생성 확인
   - 복구 방법 숙지

## 📝 변경 이력

### v1.0.0 (2024-01-28)
- 초기 버전
- 프로그램 날짜 동기화 기능
- 자동 백업/복구 기능
- DRY-RUN 모드

## 💡 도움이 필요하면

1. 이 README를 다시 확인하세요
2. `--help` 옵션으로 사용법 확인
3. `--verbose` 옵션으로 상세 로그 확인
