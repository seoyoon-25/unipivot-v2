generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String                    @id @default(cuid())
  name                     String?
  email                    String                    @unique
  emailVerified            DateTime?
  image                    String?
  password                 String?
  phone                    String?
  origin                   String?
  birthYear                Int?
  occupation               String?
  bio                      String?
  points                   Int                       @default(0)
  role                     String                    @default("USER")
  status                   String                    @default("ACTIVE")
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  arrivalYear              Int?
  originCategory           String?
  originCountry            String?
  originDetails            String?
  grade                    Int                       @default(1)
  gradeUpdatedAt           DateTime?
  profileCompleted         Boolean                   @default(false)
  birthCity                String?
  birthRegion              String?
  displayName              String?
  gender                   String?
  marketingAgreed          Boolean                   @default(false)
  marketingAgreedAt        DateTime?
  organization             String?
  privacyAgreed            Boolean                   @default(false)
  privacyAgreedAt          DateTime?
  referralSource           String?
  residenceCity            String?
  residenceRegion          String?
  termsAgreed              Boolean                   @default(false)
  termsAgreedAt            DateTime?
  accounts                 Account[]
  activityLogs             ActivityLog[]
  bankAccounts             BankAccount[]
  blogPosts                BlogPost[]
  bookSuggestions          BookSuggestion[]
  bookVotes                BookVote[]
  chatLogs                 ChatLog[]
  deposits                 Deposit[]
  donations                Donation[]
  interests                Interest[]
  interestAlerts           InterestAlert[]
  interestKeywordLikes     InterestKeywordLike[]
  interestLikes            InterestLike[]
  labProfile               LabProfile?
  member                   Member?
  gradeHistory             MemberGradeHistory[]
  notifications            Notification[]
  pointHistory             PointHistory[]
  programApplications      ProgramApplication[]
  programLikes             ProgramLike[]
  programParticipants      ProgramParticipant[]
  programReports           ProgramReport[]
  registrations            Registration[]
  reportComments           ReportComment[]
  reportLikes              ReportLike[]
  rewardClaims             RewardClaim[]
  sessions                 Session[]
  surveyResponses          SurveyResponse[]
  talents                  Talent[]
  // Phase 13: 진행자 지원 + RSVP
  programMemberships       ProgramMembership[]
  facilitatorApplications  FacilitatorApplication[]
  sessionFacilitators      SessionFacilitator[]
  sessionRSVPs             SessionRSVP[]
  // Phase 14: 발언 타이머
  speakingTimes            SpeakingTime[]
  // Phase 15: AI 어시스턴트
  aiConversations          AIConversation[]
  // Phase 16: 공지
  announcementTemplates    AnnouncementTemplate[]
  notificationSettings     NotificationSettings?
  // Phase 18: 배지/프로필
  badges                   UserBadge[]
  userProfile              UserProfile?
  // Phase 20: 읽기 도우미
  readingProgress          ReadingProgress[]
  highlights               Highlight[]
  // Phase 21: 평가
  receivedCards            ParticipantCard[]         @relation("ReceivedCards")
  issuedCards              ParticipantCard[]         @relation("IssuedCards")
  receivedNotes            OrganizerNote[]           @relation("ReceivedNotes")
  createdNotes             OrganizerNote[]           @relation("CreatedNotes")
  receivedEvaluations      SeasonEvaluation[]        @relation("ReceivedEvaluations")
  createdEvaluations       SeasonEvaluation[]        @relation("CreatedEvaluations")
  participationPermissions ParticipationPermission[] @relation("ParticipationPermissions")
  setPermissions           ParticipationPermission[] @relation("SetPermissions")
  // Phase 22: 결석 신청
  absenceRequests          AbsenceRequest[]
  absenceReviews           AbsenceRequest[]          @relation("AbsenceReviewer")
  // Phase 23: 독후감 승인
  approvedReports          BookReport[]              @relation("BookReportApprover")
  // Phase 5-6: 세션 독후감
  sessionReports           SessionReport[]
  // 이슈 설문 응답
  issueSurveyResponses     IssueSurveyResponse[]     @relation("IssueSurveyResponses")
  // Phase 6: 내 책장
  wishBooks                WishBook[]
  favoriteBooks            FavoriteBook[]
  // Phase 8: 명문장
  quotes                   Quote[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([email])
}

model Program {
  id                       String                        @id @default(cuid())
  title                    String
  slug                     String                        @unique
  type                     String
  description              String?
  content                  String?
  image                    String?
  capacity                 Int                           @default(30)
  fee                      Int                           @default(0)
  location                 String?
  isOnline                 Boolean                       @default(false)
  status                   String                        @default("DRAFT")
  startDate                DateTime?
  endDate                  DateTime?
  createdAt                DateTime                      @default(now())
  updatedAt                DateTime                      @updatedAt
  applicationCount         Int                           @default(0)
  applicationFormId        String?
  feeAmount                Int                           @default(0)
  feeType                  String                        @default("FREE")
  likeCount                Int                           @default(0)
  recruitEndDate           DateTime?
  recruitStartDate         DateTime?
  thumbnailSquare          String?
  imagePosition            Int                           @default(0) // 0=top, 50=center, 100=bottom
  currentBookContent       String?
  scheduleContent          String?
  isLegacy                 Boolean                       @default(false)
  legacyHtml               String?
  legacyImages             String?                       @default("[]")
  migratedAt               DateTime?
  originalUrl              String?
  displayOrder             Int                           @default(0)
  applicationEndAt         DateTime?
  applicationOpen          Boolean                       @default(false)
  applicationStartAt       DateTime?
  autoApproveVIP           Boolean                       @default(true)
  autoApproveVVIP          Boolean                       @default(true)
  autoRejectBlocked        Boolean                       @default(false)
  customQuestions          String?
  depositAmountSetting     Int?
  maxParticipants          Int?
  requireMotivation        Boolean                       @default(true)
  requireSelfIntro         Boolean                       @default(false)
  reportStructure          String                        @default("FREE")
  // Phase 13: 진행자 지원 + RSVP 설정
  rsvpEnabled              Boolean                       @default(true)
  rsvpDeadlineHours        Int                           @default(24)
  facilitatorIncentiveMax  Int                           @default(3) // 최대 인센티브 횟수
  books                    BookOnProgram[]
  bookReports              BookReport[]
  depositSetting           DepositSetting?
  memberAttendances        MemberAttendance[]
  applicationForm          ApplicationForm?              @relation(fields: [applicationFormId], references: [id])
  applications             ProgramApplication[]
  gallery                  ProgramGallery[]
  likes                    ProgramLike[]
  participants             ProgramParticipant[]
  programReports           ProgramReport[]
  sessions                 ProgramSession[]
  refundHistories          RefundHistory[]
  registrations            Registration[]
  surveys                  SatisfactionSurvey[]
  // Phase 13: 진행자 지원 + RSVP
  memberships              ProgramMembership[]
  checklistTemplate        FacilitatorChecklistTemplate?
  // Phase 21: 평가
  participantCards         ParticipantCard[]
  organizerNotes           OrganizerNote[]
  seasonEvaluations        SeasonEvaluation[]
  participationPermissions ParticipationPermission[]
}

model Registration {
  id        String   @id @default(cuid())
  userId    String
  programId String
  status    String   @default("PENDING")
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  program   Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, programId])
}

model PointHistory {
  id          String   @id @default(cuid())
  userId      String
  amount      Int
  type        String
  category    String
  description String
  balance     Int
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Book {
  id        String          @id @default(cuid())
  title     String
  author    String?
  publisher String?
  isbn      String?
  image     String?
  summary   String?
  createdAt DateTime        @default(now())
  programs  BookOnProgram[]
}

model BookOnProgram {
  id        String   @id @default(cuid())
  bookId    String
  programId String
  week      Int?
  createdAt DateTime @default(now())
  book      Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  program   Program  @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([bookId, programId])
}

model BookSuggestion {
  id          String     @id @default(cuid())
  title       String
  author      String?
  publisher   String?
  isbn        String?
  image       String?
  description String?
  userId      String
  voteCount   Int        @default(0)
  isSelected  Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  votes       BookVote[]

  @@index([voteCount])
  @@index([createdAt])
}

model BookVote {
  id           String         @id @default(cuid())
  userId       String
  suggestionId String
  createdAt    DateTime       @default(now())
  suggestion   BookSuggestion @relation(fields: [suggestionId], references: [id], onDelete: Cascade)
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, suggestionId])
}

model Project {
  id          String             @id @default(cuid())
  title       String
  description String?
  status      String             @default("PLANNING")
  budget      Int?
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  events      CalendarEvent[]
  documents   Document[]
  milestones  Milestone[]
  partners    PartnerOnProject[]
}

model Milestone {
  id          String    @id @default(cuid())
  projectId   String
  title       String
  description String?
  dueDate     DateTime?
  status      String    @default("PENDING")
  createdAt   DateTime  @default(now())
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Partner {
  id          String             @id @default(cuid())
  name        String
  type        String?
  contact     String?
  email       String?
  phone       String?
  description String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  projects    PartnerOnProject[]
}

model PartnerOnProject {
  id        String   @id @default(cuid())
  partnerId String
  projectId String
  role      String?
  createdAt DateTime @default(now())
  partner   Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([partnerId, projectId])
}

model Document {
  id        String   @id @default(cuid())
  projectId String?
  title     String
  type      String?
  filePath  String?
  fileSize  Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project? @relation(fields: [projectId], references: [id])
}

model CalendarEvent {
  id          String    @id @default(cuid())
  projectId   String?
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime?
  allDay      Boolean   @default(false)
  location    String?
  type        String?
  createdAt   DateTime  @default(now())
  project     Project?  @relation(fields: [projectId], references: [id])
}

model Transaction {
  id          String   @id @default(cuid())
  type        String
  category    String?
  amount      Int
  description String?
  date        DateTime
  receipt     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Deposit {
  id        String   @id @default(cuid())
  userId    String?
  amount    Int
  purpose   String?
  status    String   @default("PENDING")
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])
}

model Donation {
  id               String    @id @default(cuid())
  userId           String?
  amount           Int
  type             String?
  method           String?
  message          String?
  anonymous        Boolean   @default(false)
  status           String    @default("PENDING")
  createdAt        DateTime  @default(now())
  donorName        String?
  receiptIssued    Boolean   @default(false)
  receiptIssuedAt  DateTime?
  receiptRequested Boolean   @default(false)
  sourceId         String?
  sourceType       String?
  user             User?     @relation(fields: [userId], references: [id])
}

model Expert {
  id           String   @id @default(cuid())
  name         String
  title        String?
  organization String?
  field        String?
  bio          String?
  image        String?
  email        String?
  phone        String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Talent {
  id          String   @id @default(cuid())
  userId      String
  title       String
  category    String?
  description String?
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ChatLog {
  id        String   @id @default(cuid())
  userId    String?
  sessionId String
  role      String
  content   String
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}

model KnowledgeBase {
  id        String   @id @default(cuid())
  category  String
  question  String
  answer    String
  keywords  String?
  priority  Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notice {
  id        String   @id @default(cuid())
  title     String
  content   String
  isPinned  Boolean  @default(false)
  isPublic  Boolean  @default(true)
  views     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlogPost {
  id          String   @id @default(cuid())
  authorId    String
  title       String
  slug        String   @unique
  excerpt     String?
  content     String
  image       String?
  category    String?
  tags        String?
  isPublished Boolean  @default(false)
  views       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

model PageContent {
  id          String        @id @default(cuid())
  slug        String        @unique
  title       String
  content     String?
  metaTitle   String?
  metaDesc    String?
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  components  String?
  isPublished Boolean       @default(false)
  styles      String?
  isFolder    Boolean       @default(false)
  order       Int           @default(0)
  parentId    String?
  parent      PageContent?  @relation("PageHierarchy", fields: [parentId], references: [id])
  children    PageContent[] @relation("PageHierarchy")
}

model Menu {
  id        String   @id @default(cuid())
  parentId  String?
  title     String
  url       String?
  target    String?  @default("_self")
  position  Int      @default(0)
  isActive  Boolean  @default(true)
  location  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SiteSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String?
  type      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Banner {
  id        String    @id @default(cuid())
  title     String
  subtitle  String?
  image     String?
  link      String?
  position  String?
  isActive  Boolean   @default(true)
  startDate DateTime?
  endDate   DateTime?
  order     Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  target    String?
  targetId  String?
  details   String?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}

model MemberGradeHistory {
  id            String   @id @default(cuid())
  userId        String
  previousGrade Int
  newGrade      Int
  previousRole  String
  newRole       String
  reason        String?
  changedBy     String?
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  content   String?
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailLog {
  id        String   @id @default(cuid())
  to        String
  subject   String
  content   String?
  status    String   @default("SENT")
  error     String?
  createdAt DateTime @default(now())
}

model FiscalYear {
  id        String   @id @default(cuid())
  year      Int      @unique
  startDate DateTime
  endDate   DateTime
  isCurrent Boolean  @default(false)
  isClosed  Boolean  @default(false)
  createdAt DateTime @default(now())
  budgets   Budget[]
}

model FinanceAccount {
  id           String               @id @default(cuid())
  code         String               @unique
  name         String
  type         String
  category     String
  subcategory  String?
  description  String?
  isActive     Boolean              @default(true)
  isSystem     Boolean              @default(false)
  sortOrder    Int                  @default(0)
  createdAt    DateTime             @default(now())
  budgetItems  BudgetItem[]
  transactions FinanceTransaction[]
}

model Fund {
  id               String               @id @default(cuid())
  name             String
  type             String
  description      String?
  financeProjectId String?
  balance          Int                  @default(0)
  isActive         Boolean              @default(true)
  createdAt        DateTime             @default(now())
  budgets          Budget[]
  transactions     FinanceTransaction[]
  financeProject   FinanceProject?      @relation(fields: [financeProjectId], references: [id])
}

model FinanceProject {
  id              String              @id @default(cuid())
  name            String
  funder          String
  contractNumber  String?
  totalBudget     Int
  startDate       DateTime
  endDate         DateTime
  status          String              @default("PLANNING")
  settlementDates String?
  description     String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  funds           Fund[]
  budgetItems     ProjectBudgetItem[]
  documents       ProjectDocument[]
}

model ProjectBudgetItem {
  id               String         @id @default(cuid())
  financeProjectId String
  category         String
  subcategory      String?
  item             String
  budget           Int
  executed         Int            @default(0)
  note             String?
  sortOrder        Int            @default(0)
  financeProject   FinanceProject @relation(fields: [financeProjectId], references: [id], onDelete: Cascade)
}

model ProjectDocument {
  id               String         @id @default(cuid())
  financeProjectId String
  type             String
  name             String
  fileUrl          String
  uploadedAt       DateTime       @default(now())
  uploadedBy       String?
  financeProject   FinanceProject @relation(fields: [financeProjectId], references: [id], onDelete: Cascade)
}

model FinanceTransaction {
  id                  String         @id @default(cuid())
  date                DateTime
  type                String
  fundId              String
  financeAccountId    String
  amount              Int
  description         String
  vendor              String?
  paymentMethod       String?
  projectBudgetItemId String?
  receiptId           String?
  evidenceType        String?
  depositType         String?
  participantId       String?
  note                String?
  createdBy           String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  financeAccount      FinanceAccount @relation(fields: [financeAccountId], references: [id])
  fund                Fund           @relation(fields: [fundId], references: [id])
  receipt             Receipt?       @relation(fields: [receiptId], references: [id])
}

model Receipt {
  id           String               @id @default(cuid())
  imageUrl     String
  thumbnailUrl String?
  ocrData      String?
  ocrStatus    String               @default("PENDING")
  date         DateTime?
  amount       Int?
  vendor       String?
  status       String               @default("PENDING")
  uploadedBy   String?
  uploadedAt   DateTime             @default(now())
  transactions FinanceTransaction[]
}

model Budget {
  id           String       @id @default(cuid())
  fundId       String
  fiscalYearId String
  status       String       @default("DRAFT")
  totalAmount  Int          @default(0)
  approvedAt   DateTime?
  approvedBy   String?
  createdAt    DateTime     @default(now())
  fiscalYear   FiscalYear   @relation(fields: [fiscalYearId], references: [id])
  fund         Fund         @relation(fields: [fundId], references: [id])
  items        BudgetItem[]
}

model BudgetItem {
  id               String         @id @default(cuid())
  budgetId         String
  financeAccountId String
  amount           Int
  executed         Int            @default(0)
  note             String?
  budget           Budget         @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  financeAccount   FinanceAccount @relation(fields: [financeAccountId], references: [id])
}

model FinanceDonation {
  id              String    @id @default(cuid())
  donorId         String?
  donorName       String
  donorType       String    @default("INDIVIDUAL")
  amount          Int
  date            DateTime
  type            String    @default("ONETIME")
  designation     String?
  receiptIssued   Boolean   @default(false)
  receiptNumber   String?
  receiptIssuedAt DateTime?
  note            String?
  createdAt       DateTime  @default(now())
  donor           Donor?    @relation(fields: [donorId], references: [id])
}

model Donor {
  id             String            @id @default(cuid())
  name           String
  type           String            @default("INDIVIDUAL")
  residentId     String?
  businessId     String?
  phone          String?
  email          String?
  address        String?
  totalDonation  Int               @default(0)
  donationCount  Int               @default(0)
  lastDonationAt DateTime?
  createdAt      DateTime          @default(now())
  donations      FinanceDonation[]
}

model ProgramApplication {
  id                    String           @id @default(cuid())
  programId             String
  userId                String?
  status                String           @default("PENDING")
  appliedAt             DateTime         @default(now())
  confirmedAt           DateTime?
  cancelledAt           DateTime?
  cancelReason          String?
  note                  String?
  acceptNotifiedAt      DateTime?
  bookReceiveType       String?
  bookSurveyCompletedAt DateTime?
  customFields          String?
  depositAmount         Int?
  depositNote           String?
  depositNotifiedAt     DateTime?
  depositPaid           Boolean          @default(false)
  depositPaidAt         DateTime?
  ebookProvider         String?
  ebookProviderOther    String?
  email                 String?
  facePrivacy           Boolean          @default(false)
  hometown              String?
  motivation            String?
  privacyAgreed         Boolean          @default(true)
  referrer              String?
  rejectNotifiedAt      DateTime?
  residence             String?
  source                String?
  depositStatus         String           @default("NONE")
  donatedAmount         Int?
  donatedAt             DateTime?
  refundCalculation     String?
  refundNote            String?
  refundableAmount      Int?
  refundedAmount        Int?
  refundedAt            DateTime?
  surveySubmitted       Boolean          @default(false)
  surveySubmittedAt     DateTime?
  agreedToPrivacy       Boolean          @default(false)
  agreedToRules         Boolean          @default(false)
  agreedToTerms         Boolean          @default(false)
  alertLevel            String?
  approvalNote          String?
  birthDate             DateTime?
  birthYear             Int?
  gender                String?
  matchType             String?
  matchedMemberCode     String?
  matchedMemberId       String?
  memberGrade           String?
  memberId              String?
  memberStatus          String?
  name                  String?
  organization          String?
  origin                String?
  phone                 String?
  processedAt           DateTime?
  processedBy           String?
  referralSource        String?
  referrerName          String?
  rejectReason          String?
  selfIntro             String?
  updatedAt             DateTime         @default(now()) @updatedAt
  member                Member?          @relation(fields: [memberId], references: [id])
  program               Program          @relation(fields: [programId], references: [id], onDelete: Cascade)
  user                  User?            @relation(fields: [userId], references: [id])
  surveyReminders       SurveyReminder[]
  surveyResponse        SurveyResponse?

  @@unique([programId, userId])
  @@index([programId])
  @@index([memberId])
  @@index([userId])
  @@index([status])
  @@index([alertLevel])
  @@index([email])
}

model ProgramGallery {
  id         String   @id @default(cuid())
  programId  String
  imageUrl   String
  caption    String?
  sortOrder  Int      @default(0)
  uploadedAt DateTime @default(now())
  program    Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
}

model DepositSetting {
  id                 String    @id @default(cuid())
  programId          String    @unique
  isEnabled          Boolean   @default(true)
  totalSessions      Int
  depositAmount      Int
  conditionType      String
  attendanceRate     Int       @default(80)
  reportRate         Int?
  status             String    @default("ACTIVE")
  settledAt          DateTime?
  settledBy          String?
  totalDeposits      Int       @default(0)
  totalReturned      Int       @default(0)
  totalForfeited     Int       @default(0)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  depositPerSession  Boolean   @default(false)
  perSessionAmount   Int?
  refundPolicy       String?
  surveyDeadlineDays Int       @default(7)
  surveyRequired     Boolean   @default(true)
  totalDonated       Int       @default(0)
  program            Program   @relation(fields: [programId], references: [id], onDelete: Cascade)
}

model ProgramParticipant {
  id                   String              @id @default(cuid())
  programId            String
  userId               String
  status               String              @default("ACTIVE")
  joinedAt             DateTime            @default(now())
  depositAmount        Int                 @default(0)
  depositPaidAt        DateTime?
  depositStatus        String              @default("NONE")
  finalAttendanceRate  Float?
  finalReportRate      Float?
  returnAmount         Int?
  forfeitAmount        Int?
  returnMethod         String?
  settledAt            DateTime?
  settleNote           String?
  depositTransactionId String?
  returnTransactionId  String?
  forfeitTransactionId String?
  attendances          ProgramAttendance[]
  program              Program             @relation(fields: [programId], references: [id], onDelete: Cascade)
  user                 User                @relation(fields: [userId], references: [id])
  reports              ProgramReport[]
  absenceRequests      AbsenceRequest[]

  @@unique([programId, userId])
}

model ProgramSession {
  id                      String                   @id @default(cuid())
  programId               String
  title                   String?
  date                    DateTime
  startTime               String?
  endTime                 String?
  location                String?
  createdAt               DateTime                 @default(now())
  bookRange               String?
  bookTitle               String?
  description             String?
  qrCode                  String?                  @unique
  qrExpiresAt             DateTime?
  reportDeadline          DateTime?
  sessionNo               Int
  status                  String                   @default("SCHEDULED")
  bookAuthor              String?
  bookImage               String?
  qrTokens                AttendanceQR[]
  bookReports             BookReport[]
  attendances             ProgramAttendance[]
  reports                 ProgramReport[]
  surveys                 SatisfactionSurvey[]
  program                 Program                  @relation(fields: [programId], references: [id], onDelete: Cascade)
  // Phase 13: 진행자 지원 + RSVP
  facilitatorApplications FacilitatorApplication[]
  facilitators            SessionFacilitator[]
  rsvps                   SessionRSVP[]
  // Phase 14: 발언 타이머
  speakingTimes           SpeakingTime[]
  speakingStats           SessionSpeakingStats?
  // Phase 15: AI 어시스턴트
  aiConversations         AIConversation[]
  aiGeneratedQuestions    AIGeneratedQuestion[]
  // Phase 16: 공지
  announcements           SessionAnnouncement[]
  // Phase 17: 녹음/블로그
  recordings              SessionRecording[]
  // Phase 19: 아카이브
  archive                 SessionArchive?
  // Phase 20: 읽기 도우미
  readingProgress         ReadingProgress[]
  highlights              Highlight[]
  // Phase 21: 평가
  participantCards        ParticipantCard[]
  // Phase 22: 결석 신청
  absenceRequests         AbsenceRequest[]
  // Phase 5-6: 세션 독후감
  sessionReports          SessionReport[]

  @@unique([programId, sessionNo])
}

model ProgramAttendance {
  id            String             @id @default(cuid())
  sessionId     String
  participantId String
  status        String             @default("ABSENT")
  checkedAt     DateTime?
  checkMethod   String?
  note          String?
  deviceInfo    String?
  qrTokenId     String?
  participant   ProgramParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  qrToken       AttendanceQR?      @relation(fields: [qrTokenId], references: [id])
  session       ProgramSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, participantId])
  @@index([qrTokenId])
}

model ProgramReport {
  id            String             @id @default(cuid())
  sessionId     String
  participantId String
  userId        String
  programId     String
  title         String
  content       String
  charCount     Int                @default(0)
  photoUrl      String?
  question      String?
  status        String             @default("DRAFT")
  submittedAt   DateTime?
  visibility    String             @default("PARTICIPANTS")
  viewCount     Int                @default(0)
  likeCount     Int                @default(0)
  commentCount  Int                @default(0)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  participant   ProgramParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  program       Program            @relation(fields: [programId], references: [id], onDelete: Cascade)
  session       ProgramSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user          User               @relation(fields: [userId], references: [id])
  comments      ReportComment[]
  likes         ReportLike[]

  @@unique([sessionId, participantId])
}

model ReportComment {
  id        String        @id @default(cuid())
  reportId  String
  userId    String
  content   String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  report    ProgramReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id])
}

model ReportLike {
  id        String        @id @default(cuid())
  reportId  String
  userId    String
  createdAt DateTime      @default(now())
  report    ProgramReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id])

  @@unique([reportId, userId])
}

model ProgramLike {
  id        String   @id @default(cuid())
  programId String
  userId    String
  createdAt DateTime @default(now())
  program   Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([programId, userId])
}

model ApplicationForm {
  id          String    @id @default(cuid())
  name        String
  description String?
  isDefault   Boolean   @default(false)
  fields      String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  programs    Program[]
}

model NotificationTemplate {
  id        String   @id @default(cuid())
  type      String
  name      String
  subject   String
  content   String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NotificationLog {
  id             String    @id @default(cuid())
  type           String
  recipientId    String?
  recipientEmail String?
  recipientPhone String?
  subject        String
  content        String
  channel        String
  status         String    @default("PENDING")
  sentAt         DateTime?
  errorMessage   String?
  createdAt      DateTime  @default(now())
}

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}

model InterestKeyword {
  id                String                @id @default(cuid())
  keyword           String                @unique
  category          String?
  totalCount        Int                   @default(0)
  monthlyCount      Int                   @default(0)
  likeCount         Int                   @default(0)
  relatedProgramIds String?
  isFixed           Boolean               @default(false)
  isRecommended     Boolean               @default(false)
  isHidden          Boolean               @default(false)
  lastUsedAt        DateTime?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  interests         Interest[]
  alerts            InterestAlert[]
  keywordLikes      InterestKeywordLike[]
}

model Interest {
  id         String          @id @default(cuid())
  keywordId  String
  content    String?
  userId     String?
  sessionId  String?
  nickname   String?
  visibility String          @default("ANONYMOUS")
  likeCount  Int             @default(0)
  ipHash     String?
  createdAt  DateTime        @default(now())
  keyword    InterestKeyword @relation(fields: [keywordId], references: [id], onDelete: Cascade)
  user       User?           @relation(fields: [userId], references: [id])
  likes      InterestLike[]
}

model InterestLike {
  id         String   @id @default(cuid())
  interestId String
  userId     String?
  sessionId  String?
  createdAt  DateTime @default(now())
  interest   Interest @relation(fields: [interestId], references: [id], onDelete: Cascade)
  user       User?    @relation(fields: [userId], references: [id])

  @@unique([interestId, userId])
  @@unique([interestId, sessionId])
}

model InterestKeywordLike {
  id        String          @id @default(cuid())
  keywordId String
  userId    String?
  sessionId String?
  createdAt DateTime        @default(now())
  keyword   InterestKeyword @relation(fields: [keywordId], references: [id], onDelete: Cascade)
  user      User?           @relation(fields: [userId], references: [id])

  @@unique([keywordId, userId])
  @@unique([keywordId, sessionId])
}

model InterestAlert {
  id                String          @id @default(cuid())
  keywordId         String
  userId            String?
  email             String
  name              String?
  isActive          Boolean         @default(true)
  notifiedAt        DateTime?
  notifiedProgramId String?
  createdAt         DateTime        @default(now())
  keyword           InterestKeyword @relation(fields: [keywordId], references: [id], onDelete: Cascade)
  user              User?           @relation(fields: [userId], references: [id])

  @@unique([keywordId, email])
}

model InterestSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}

// 키워드 간 연결 관계 (네트워크 그래프용)
model KeywordConnection {
  id            String   @id @default(cuid())
  fromKeywordId String
  toKeywordId   String
  strength      Int      @default(1) // 동시 선택 횟수
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([fromKeywordId, toKeywordId])
  @@index([fromKeywordId])
  @@index([toKeywordId])
}

// 이슈 기반 설문조사 (벽보판용)
model IssueSurvey {
  id          String                @id @default(cuid())
  title       String                // 설문 제목
  description String?               // 설문 설명
  type        String                @default("SINGLE_CHOICE") // SINGLE_CHOICE, MULTIPLE_CHOICE, TEXT, SCALE
  status      String                @default("DRAFT") // DRAFT, ACTIVE, CLOSED
  startDate   DateTime?             // 시작일
  endDate     DateTime?             // 종료일
  isAnonymous Boolean               @default(true) // 익명 여부
  isPinned    Boolean               @default(false) // 상단 고정
  order       Int                   @default(0)
  createdBy   String?               // 생성자 (관리자 ID)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  options     IssueSurveyOption[]
  responses   IssueSurveyResponse[]

  @@index([status])
  @@index([isPinned, order])
}

// 이슈 설문 선택지
model IssueSurveyOption {
  id        String                @id @default(cuid())
  surveyId  String
  text      String                // 선택지 텍스트
  order     Int                   @default(0)
  color     String?               // 결과 시각화용 색상
  createdAt DateTime              @default(now())
  survey    IssueSurvey           @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  responses IssueSurveyResponse[]

  @@index([surveyId])
}

// 이슈 설문 응답
model IssueSurveyResponse {
  id         String             @id @default(cuid())
  surveyId   String
  optionId   String?            // 선택형 응답
  textValue  String?            // 텍스트 응답
  scaleValue Int?               // 척도 응답 (1-5, 1-10 등)
  comment    String?            // 추가 의견
  likeCount  Int                @default(0)  // 공감 수
  userId     String?            // 회원 응답
  sessionId  String?            // 비회원 응답
  ipHash     String?            // 중복 방지
  createdAt  DateTime           @default(now())
  survey     IssueSurvey        @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  option     IssueSurveyOption? @relation(fields: [optionId], references: [id], onDelete: SetNull)
  user       User?              @relation("IssueSurveyResponses", fields: [userId], references: [id], onDelete: SetNull)

  @@unique([surveyId, userId])
  @@unique([surveyId, sessionId])
  @@index([surveyId])
  @@index([optionId])
}

model CooperationSection {
  id         String   @id @default(cuid())
  order      Int      @default(0)
  title      String
  content    String
  image      String?
  imageAlt   String?
  buttonText String   @default("요청하기")
  buttonLink String
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model ConsultingRequest {
  id           String   @id @default(cuid())
  startDate    DateTime
  endDate      DateTime
  duration     Int
  method       String
  fee          Int?
  requirements String
  organization String
  contactName  String
  email        String
  phone        String
  attachment   String?
  status       String   @default("PENDING")
  adminNote    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model LecturerRequest {
  id              String   @id @default(cuid())
  topic           String
  schedules       String
  method          String
  requirements    String
  fee             String?
  organization    String
  contactName     String
  contactTitle    String?
  email           String
  phone           String
  attachment      String?
  feeAgreement    Boolean  @default(false)
  matchedExpertId String?
  status          String   @default("PENDING")
  adminNote       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model SurveyRequest {
  id             String   @id @default(cuid())
  startDate      DateTime
  endDate        DateTime
  questionCount  Int
  estimatedTime  Int
  serviceFee     Int?
  participantFee Int?
  requirements   String
  requesterType  String
  requesterName  String
  email          String
  phone          String
  attachment     String?
  status         String   @default("PENDING")
  adminNote      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model ExpertProfile {
  id                     String                  @id @default(cuid())
  userId                 String?                 @unique
  name                   String
  nameEn                 String?
  photo                  String?
  title                  String?
  organization           String?
  email                  String
  phone                  String?
  origin                 String                  @default("NORTH")
  defectionYear          Int?
  settlementYear         Int?
  hometown               String?
  education              String?
  career                 String?
  certifications         String?
  categories             String?
  specialties            String?
  keywords               String?
  lectureTopics          String?
  lectureAreas           String?
  lectureFeeMin          Int?
  lectureFeeMax          Int?
  lectureNote            String?
  consultingAreas        String?
  consultingFee          Int?
  researchInterests      String?
  surveyAvailable        Boolean                 @default(true)
  interviewAvailable     Boolean                 @default(true)
  bio                    String?
  portfolio              String?
  sns                    String?
  lectureCount           Int                     @default(0)
  consultingCount        Int                     @default(0)
  researchCount          Int                     @default(0)
  rating                 Float?
  isVerified             Boolean                 @default(false)
  isPublic               Boolean                 @default(false)
  isActive               Boolean                 @default(true)
  viewCount              Int                     @default(0)
  verifiedAt             DateTime?
  verifiedBy             String?
  adminNote              String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  arrivalYear            Int?
  originCategory         String?
  originCountry          String?
  targetExpertise        String?
  labProfile             LabProfile?
  lectureMatches         LectureMatch[]
  researchParticipations ResearchParticipation[]
}

model LabProfile {
  id                       String         @id @default(cuid())
  userId                   String         @unique
  profileComplete          Boolean        @default(false)
  lastActiveAt             DateTime?
  birthYear                Int?
  birthRegion              String?
  hometown                 String?
  leftHometownYear         Int?
  enteredKoreaYear         Int?
  maritalStatus            String?
  educationHometown        String?
  educationKorea           String?
  occupations              String?
  phoneVerified            Boolean        @default(false)
  phoneVerifiedAt          DateTime?
  verificationCI           String?        @unique
  badges                   String?
  surveyCount              Int            @default(0)
  interviewCount           Int            @default(0)
  lectureCount             Int            @default(0)
  expertProfileId          String?        @unique
  expertVerificationStatus String         @default("NONE")
  expertVerifiedAt         DateTime?
  expertVerifiedBy         String?
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt
  expertProfile            ExpertProfile? @relation(fields: [expertProfileId], references: [id])
  user                     User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model LectureMatch {
  id             String        @id @default(cuid())
  requestId      String?
  expertId       String
  topic          String?
  date           DateTime?
  duration       Int?
  method         String?
  location       String?
  fee            Int?
  requesterOrg   String?
  requesterName  String?
  requesterEmail String?
  requesterPhone String?
  status         String        @default("PENDING")
  rating         Int?
  feedback       String?
  actualFee      Int?
  isPaid         Boolean       @default(false)
  paidAt         DateTime?
  adminNote      String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  expert         ExpertProfile @relation(fields: [expertId], references: [id], onDelete: Cascade)
}

model LabSurvey {
  id               String                  @id @default(cuid())
  title            String
  description      String?
  type             String                  @default("SURVEY")
  targetCount      Int                     @default(10)
  currentCount     Int                     @default(0)
  targetOrigin     String?
  targetAgeMin     Int?
  targetAgeMax     Int?
  targetGender     String?
  targetConditions String?
  questionCount    Int?
  estimatedTime    Int?
  questions        String?
  externalUrl      String?
  rewardType       String                  @default("CASH")
  rewardAmount     Int?
  rewardNote       String?
  startDate        DateTime
  endDate          DateTime
  isExternal       Boolean                 @default(false)
  requesterName    String?
  requesterOrg     String?
  requesterEmail   String?
  requesterPhone   String?
  status           String                  @default("DRAFT")
  isPublic         Boolean                 @default(true)
  adminNote        String?
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  targetCategories String?
  targetCountries  String?
  participations   ResearchParticipation[]
  rewardClaims     RewardClaim[]
}

model ResearchParticipation {
  id             String         @id @default(cuid())
  surveyId       String
  expertId       String?
  userId         String?
  name           String?
  email          String?
  phone          String?
  origin         String?
  status         String         @default("APPLIED")
  responses      String?
  completedAt    DateTime?
  rewardStatus   String         @default("PENDING")
  rewardAmount   Int?
  paidAt         DateTime?
  note           String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  originCategory String?
  originCountry  String?
  expert         ExpertProfile? @relation(fields: [expertId], references: [id])
  survey         LabSurvey      @relation(fields: [surveyId], references: [id], onDelete: Cascade)
}

model RewardClaim {
  id             String    @id @default(cuid())
  surveyId       String
  userId         String
  realName       String
  phoneNumber    String
  bankCode       String
  bankName       String
  accountNumber  String
  amount         Int
  ipAddress      String
  userAgent      String?
  fingerprint    String?
  flagged        Boolean   @default(false)
  flagReason     String?
  riskScore      Int       @default(0)
  status         String    @default("PENDING")
  rejectedReason String?
  approvedAt     DateTime?
  approvedBy     String?
  paidAt         DateTime?
  paidBy         String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  survey         LabSurvey @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([surveyId, userId])
  @@index([surveyId, ipAddress])
  @@index([accountNumber])
  @@index([phoneNumber])
  @@index([status])
  @@index([flagged])
}

model ExpertCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  nameEn      String?
  description String?
  icon        String?
  color       String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
}

model ResearchTrend {
  id            String    @id @default(cuid())
  title         String
  authors       String?
  source        String
  sourceUrl     String?
  publishedDate DateTime?
  abstract      String?
  keywords      String?
  category      String?
  views         Int       @default(0)
  isActive      Boolean   @default(true)
  crawledAt     DateTime  @default(now())
  createdAt     DateTime  @default(now())
}

model BankAccount {
  id              String           @id @default(cuid())
  userId          String
  bankCode        String
  bankName        String
  accountNumber   String
  accountHolder   String
  isDefault       Boolean          @default(false)
  isVerified      Boolean          @default(false)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  surveyResponses SurveyResponse[]

  @@unique([userId, bankCode, accountNumber])
  @@index([userId])
}

model SatisfactionSurvey {
  id              String           @id @default(cuid())
  programId       String
  title           String
  description     String?
  questions       String
  deadline        DateTime
  reminderSent    Boolean          @default(false)
  status          String           @default("DRAFT")
  sentAt          DateTime?
  closedAt        DateTime?
  targetCount     Int              @default(0)
  responseCount   Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  lastReminderAt  DateTime?
  reminderDays    String?          @default("[3, 1]")
  reminderEnabled Boolean          @default(true)
  templateId      String?
  surveyType      String           @default("program")
  sessionId       String?
  includeRefund   Boolean          @default(false)
  program         Program          @relation(fields: [programId], references: [id], onDelete: Cascade)
  session         ProgramSession?  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  reminders       SurveyReminder[]
  responses       SurveyResponse[]

  @@index([programId])
  @@index([sessionId])
  @@index([surveyType])
}

model SurveyResponse {
  id               String             @id @default(cuid())
  surveyId         String
  applicationId    String             @unique
  userId           String
  answers          String
  refundChoice     String             @default("REFUND")
  bankAccountId    String?
  newBankCode      String?
  newBankName      String?
  newAccountNumber String?
  newAccountHolder String?
  saveNewAccount   Boolean            @default(false)
  donationMessage  String?
  isAnonymous      Boolean            @default(false)
  receiptRequested Boolean            @default(false)
  submittedAt      DateTime           @default(now())
  application      ProgramApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  bankAccount      BankAccount?       @relation(fields: [bankAccountId], references: [id])
  survey           SatisfactionSurvey @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  user             User               @relation(fields: [userId], references: [id])

  @@index([surveyId])
  @@index([userId])
}

model SurveyReminder {
  id                 String             @id @default(cuid())
  surveyId           String
  applicationId      String
  userId             String
  daysBeforeDeadline Int
  sentAt             DateTime           @default(now())
  channel            String             @default("KAKAO")
  status             String             @default("SENT")
  application        ProgramApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  survey             SatisfactionSurvey @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@unique([surveyId, applicationId, daysBeforeDeadline])
  @@index([surveyId])
  @@index([sentAt])
}

model ContentTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String
  content     String
  thumbnail   String?
  isDefault   Boolean  @default(false)
  isPublic    Boolean  @default(true)
  useCount    Int      @default(0)
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AttendanceQR {
  id          String              @id @default(cuid())
  sessionId   String
  token       String              @unique
  validFrom   DateTime
  validUntil  DateTime
  isActive    Boolean             @default(true)
  createdBy   String
  createdAt   DateTime            @default(now())
  session     ProgramSession      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  attendances ProgramAttendance[]

  @@index([sessionId])
  @@index([token])
}

model SiteSection {
  id          String   @id @default(cuid())
  sectionKey  String   @unique
  sectionName String
  content     String
  isVisible   Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SiteSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  category    String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AnnouncementBanner {
  id               String            @id @default(cuid())
  title            String
  content          String?
  type             String            @default("INFO")
  backgroundColor  String?
  textColor        String?
  icon             String?
  linkUrl          String?
  linkText         String?
  openInNewTab     Boolean           @default(false)
  position         String            @default("TOP")
  isSticky         Boolean           @default(false)
  showCloseButton  Boolean           @default(true)
  autoDismiss      Boolean           @default(false)
  autoDismissDelay Int?
  isScheduled      Boolean           @default(false)
  startDate        DateTime?
  endDate          DateTime?
  targetPages      String?
  targetRoles      String?
  excludePages     String?
  isActive         Boolean           @default(true)
  priority         Int               @default(0)
  maxDisplayCount  Int?
  impressionCount  Int               @default(0)
  clickCount       Int               @default(0)
  dismissCount     Int               @default(0)
  createdBy        String?
  updatedBy        String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  analytics        BannerAnalytics[]
  userDismissals   BannerDismissal[]
}

model BannerDismissal {
  id          String             @id @default(cuid())
  bannerId    String
  userId      String?
  sessionId   String?
  ipHash      String?
  dismissedAt DateTime           @default(now())
  banner      AnnouncementBanner @relation(fields: [bannerId], references: [id], onDelete: Cascade)

  @@unique([bannerId, userId])
  @@unique([bannerId, sessionId])
  @@index([bannerId])
}

model BannerAnalytics {
  id          String             @id @default(cuid())
  bannerId    String
  date        DateTime
  impressions Int                @default(0)
  clicks      Int                @default(0)
  dismissals  Int                @default(0)
  uniqueUsers Int                @default(0)
  banner      AnnouncementBanner @relation(fields: [bannerId], references: [id], onDelete: Cascade)

  @@unique([bannerId, date])
  @@index([bannerId])
  @@index([date])
}

model FloatingButton {
  id              String                    @id @default(cuid())
  title           String
  icon            String?
  color           String                    @default("#2563eb")
  hoverColor      String?
  textColor       String                    @default("#ffffff")
  linkUrl         String
  openInNewTab    Boolean                   @default(false)
  position        String                    @default("BOTTOM_RIGHT")
  offsetX         Int                       @default(20)
  offsetY         Int                       @default(20)
  size            String                    @default("MEDIUM")
  showLabel       Boolean                   @default(true)
  animation       String                    @default("NONE")
  animationDelay  Int                       @default(0)
  showOn          String                    @default("ALL")
  scrollThreshold Int?
  isScheduled     Boolean                   @default(false)
  startDate       DateTime?
  endDate         DateTime?
  targetPages     String?
  targetRoles     String?
  excludePages    String?
  isActive        Boolean                   @default(true)
  priority        Int                       @default(0)
  maxDisplayCount Int?
  impressionCount Int                       @default(0)
  clickCount      Int                       @default(0)
  createdBy       String?
  updatedBy       String?
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  analytics       FloatingButtonAnalytics[]
  dismissals      FloatingButtonDismissal[]
}

model FloatingButtonDismissal {
  id          String         @id @default(cuid())
  buttonId    String
  userId      String?
  sessionId   String?
  ipHash      String?
  dismissedAt DateTime       @default(now())
  button      FloatingButton @relation(fields: [buttonId], references: [id], onDelete: Cascade)

  @@unique([buttonId, userId])
  @@unique([buttonId, sessionId])
  @@index([buttonId])
}

model FloatingButtonAnalytics {
  id          String         @id @default(cuid())
  buttonId    String
  date        DateTime
  impressions Int            @default(0)
  clicks      Int            @default(0)
  uniqueUsers Int            @default(0)
  button      FloatingButton @relation(fields: [buttonId], references: [id], onDelete: Cascade)

  @@unique([buttonId, date])
  @@index([buttonId])
  @@index([date])
}

model SeoSetting {
  id                 String   @id @default(cuid())
  pageKey            String   @unique
  pageName           String
  title              String?
  description        String?
  keywords           String?
  canonical          String?
  ogTitle            String?
  ogDescription      String?
  ogImage            String?
  ogImageAlt         String?
  ogType             String   @default("website")
  ogUrl              String?
  twitterCard        String   @default("summary_large_image")
  twitterTitle       String?
  twitterDescription String?
  twitterImage       String?
  twitterImageAlt    String?
  twitterSite        String?
  twitterCreator     String?
  schemaType         String?
  schemaData         String?
  customHead         String?
  robots             String   @default("index,follow")
  isActive           Boolean  @default(true)
  priority           Int      @default(0)
  createdBy          String?
  updatedBy          String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model SeoTemplate {
  id                         String   @id @default(cuid())
  templateKey                String   @unique
  templateName               String
  titleTemplate              String?
  descriptionTemplate        String?
  keywordsTemplate           String?
  ogTitleTemplate            String?
  ogDescriptionTemplate      String?
  ogImageTemplate            String?
  twitterTitleTemplate       String?
  twitterDescriptionTemplate String?
  twitterImageTemplate       String?
  schemaTemplate             String?
  isActive                   Boolean  @default(true)
  createdBy                  String?
  updatedBy                  String?
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
}

model GlobalSeoSetting {
  id                     String   @id @default(cuid())
  settingKey             String   @unique
  siteName               String?
  siteDescription        String?
  siteUrl                String?
  defaultImage           String?
  twitterHandle          String?
  facebookPage           String?
  linkedinPage           String?
  youtubeChannel         String?
  googleSiteVerification String?
  googleAnalyticsId      String?
  googleTagManagerId     String?
  naverSiteVerification  String?
  bingSiteVerification   String?
  robotsTxt              String?
  sitemapEnabled         Boolean  @default(true)
  sitemapPriority        Float    @default(0.5)
  sitemapChangefreq      String   @default("weekly")
  updatedBy              String?
  updatedAt              DateTime @updatedAt
}

model PreviewSession {
  id           String            @id @default(cuid())
  userId       String
  sessionKey   String            @unique
  title        String
  description  String?
  isActive     Boolean           @default(true)
  expiresAt    DateTime?
  password     String?
  allowEdit    Boolean           @default(false)
  isPublic     Boolean           @default(false)
  shareUrl     String?
  lastViewedAt DateTime?
  viewCount    Int               @default(0)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  changes      PreviewChange[]
  snapshots    PreviewSnapshot[]

  @@index([userId])
  @@index([sessionKey])
}

model PreviewSnapshot {
  id            String         @id @default(cuid())
  sessionId     String
  name          String
  description   String?
  dataType      String
  data          String
  checksum      String
  device        String         @default("desktop")
  theme         String         @default("light")
  screenshotUrl String?
  createdBy     String
  createdAt     DateTime       @default(now())
  session       PreviewSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([dataType])
}

model PreviewDevice {
  id         String   @id @default(cuid())
  name       String   @unique
  type       String
  width      Int
  height     Int
  pixelRatio Float    @default(1.0)
  userAgent  String?
  isDefault  Boolean  @default(false)
  isActive   Boolean  @default(true)
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([type])
  @@index([isDefault])
}

model PreviewChange {
  id         String         @id @default(cuid())
  sessionId  String
  changeType String
  action     String
  targetId   String
  targetType String
  before     String?
  after      String?
  userId     String
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime       @default(now())
  session    PreviewSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([changeType])
  @@index([timestamp])
}

model PopupTemplate {
  id              String   @id @default(cuid())
  name            String
  category        String   @default("modal")
  width           Int      @default(600)
  height          Int      @default(400)
  borderRadius    Int      @default(12)
  shadow          String   @default("large")
  backgroundColor String   @default("#ffffff")
  borderColor     String   @default("#e2e8f0")
  textColor       String   @default("#1e293b")
  animation       String   @default("fade")
  duration        Int      @default(300)
  overlayColor    String   @default("rgba(0,0,0,0.5)")
  blurBackground  Boolean  @default(false)
  isDefault       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  popups          Popup[]

  @@index([category])
  @@index([isDefault])
}

model Popup {
  id                   String             @id @default(cuid())
  title                String
  content              String?
  templateId           String?
  customCss            String?
  trigger              String             @default("pageload")
  triggerValue         String?
  triggerSelector      String?
  showOn               String             @default("all")
  targetPages          String?
  targetRoles          String?
  excludePages         String?
  newVisitorOnly       Boolean            @default(false)
  returningVisitorOnly Boolean            @default(false)
  minVisitCount        Int?
  targetCountries      String?
  targetLanguages      String?
  showAfterDate        DateTime?
  showUntilDate        DateTime?
  showTimeSlots        String?
  showOncePerSession   Boolean            @default(false)
  showOncePerUser      Boolean            @default(false)
  maxDisplayPerDay     Int?
  delayBetweenShows    Int?
  showCloseButton      Boolean            @default(true)
  closeOnOverlay       Boolean            @default(false)
  closeOnEscape        Boolean            @default(true)
  autoClose            Boolean            @default(false)
  autoCloseDelay       Int?
  primaryButton        String?
  secondaryButton      String?
  isActive             Boolean            @default(true)
  priority             Int                @default(0)
  impressionCount      Int                @default(0)
  clickCount           Int                @default(0)
  conversionCount      Int                @default(0)
  dismissCount         Int                @default(0)
  createdBy            String?
  updatedBy            String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  template             PopupTemplate?     @relation(fields: [templateId], references: [id])
  analytics            PopupAnalytics[]
  dismissals           PopupDismissal[]
  interactions         PopupInteraction[]

  @@index([isActive])
  @@index([trigger])
  @@index([priority])
}

model PopupDismissal {
  id          String   @id @default(cuid())
  popupId     String
  userId      String?
  sessionId   String?
  ipHash      String?
  reason      String?
  dismissedAt DateTime @default(now())
  popup       Popup    @relation(fields: [popupId], references: [id], onDelete: Cascade)

  @@unique([popupId, userId])
  @@unique([popupId, sessionId])
  @@index([popupId])
}

model PopupInteraction {
  id              String   @id @default(cuid())
  popupId         String
  userId          String?
  sessionId       String
  interactionType String
  buttonType      String?
  value           String?
  timestamp       DateTime @default(now())
  popup           Popup    @relation(fields: [popupId], references: [id], onDelete: Cascade)

  @@index([popupId])
  @@index([interactionType])
  @@index([timestamp])
}

model PopupAnalytics {
  id             String   @id @default(cuid())
  popupId        String
  date           DateTime
  impressions    Int      @default(0)
  clicks         Int      @default(0)
  conversions    Int      @default(0)
  dismissals     Int      @default(0)
  uniqueUsers    Int      @default(0)
  bounceRate     Float?
  conversionRate Float?
  popup          Popup    @relation(fields: [popupId], references: [id], onDelete: Cascade)

  @@unique([popupId, date])
  @@index([popupId])
  @@index([date])
}

model ChangeHistory {
  id            String     @id @default(cuid())
  entityType    String
  entityId      String
  action        String
  fieldName     String?
  previousValue String?
  newValue      String?
  fullSnapshot  String
  userId        String
  ipAddress     String?
  userAgent     String?
  description   String?
  changeVersion Int        @default(0)
  isAutoSave    Boolean    @default(false)
  createdAt     DateTime   @default(now())
  rollbacks     Rollback[]

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@index([changeVersion])
}

model Rollback {
  id               String        @id @default(cuid())
  targetHistoryId  String
  rollbackType     String
  affectedEntities String
  userId           String
  reason           String?
  rolledBackAt     DateTime      @default(now())
  targetHistory    ChangeHistory @relation(fields: [targetHistoryId], references: [id], onDelete: Cascade)

  @@index([targetHistoryId])
  @@index([userId])
  @@index([rolledBackAt])
}

model BackupConfig {
  id                String   @id @default(cuid())
  entityType        String   @unique
  enableAutoBackup  Boolean  @default(true)
  backupInterval    Int      @default(24)
  maxVersions       Int      @default(100)
  enableCompression Boolean  @default(true)
  compressAfterDays Int      @default(7)
  autoCleanup       Boolean  @default(true)
  retentionDays     Int      @default(90)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([entityType])
}

model RestorePoint {
  id          String   @id @default(cuid())
  name        String
  description String?
  snapshot    String
  userId      String
  isAutomatic Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([isAutomatic])
}

model ThemeSettings {
  id                String                @id @default(cuid())
  name              String                @unique
  displayName       String
  description       String?
  primary           String                @default("#2563eb")
  secondary         String                @default("#64748b")
  background        String                @default("#ffffff")
  surface           String                @default("#f8fafc")
  textPrimary       String                @default("#1e293b")
  textSecondary     String                @default("#64748b")
  textMuted         String                @default("#94a3b8")
  border            String                @default("#e2e8f0")
  divider           String                @default("#f1f5f9")
  success           String                @default("#10b981")
  warning           String                @default("#f59e0b")
  error             String                @default("#ef4444")
  info              String                @default("#3b82f6")
  accent            String                @default("#8b5cf6")
  accentForeground  String                @default("#ffffff")
  input             String                @default("#ffffff")
  inputBorder       String                @default("#d1d5db")
  card              String                @default("#ffffff")
  cardBorder        String                @default("#e5e7eb")
  navBackground     String                @default("#ffffff")
  navText           String                @default("#374151")
  navHover          String                @default("#f3f4f6")
  sidebarBackground String                @default("#f9fafb")
  sidebarText       String                @default("#374151")
  sidebarHover      String                @default("#f3f4f6")
  footerBackground  String                @default("#1f2937")
  footerText        String                @default("#d1d5db")
  customCss         String?
  isDefault         Boolean               @default(false)
  isActive          Boolean               @default(true)
  isSystemTheme     Boolean               @default(false)
  autoApply         Boolean               @default(false)
  autoApplyStart    String?
  autoApplyEnd      String?
  createdBy         String?
  updatedBy         String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  userPreferences   UserThemePreference[]

  @@index([name])
  @@index([isDefault])
  @@index([isActive])
}

model UserThemePreference {
  id             String         @id @default(cuid())
  userId         String         @unique
  themeId        String?
  preferAuto     Boolean        @default(true)
  followSystem   Boolean        @default(true)
  lightThemeId   String?
  darkThemeId    String?
  autoSwitchTime Boolean        @default(false)
  lightModeStart String?
  lightModeEnd   String?
  lastUsedTheme  String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  theme          ThemeSettings? @relation(fields: [themeId], references: [id])

  @@index([userId])
  @@index([themeId])
}

model ThemeAnalytics {
  id           String   @id @default(cuid())
  themeId      String
  date         DateTime
  activeUsers  Int      @default(0)
  sessions     Int      @default(0)
  duration     Int      @default(0)
  desktopUsers Int      @default(0)
  mobileUsers  Int      @default(0)
  tabletUsers  Int      @default(0)
  createdAt    DateTime @default(now())

  @@unique([themeId, date])
  @@index([themeId])
  @@index([date])
}

model CustomCode {
  id              String                 @id @default(cuid())
  name            String
  description     String?
  type            String
  code            String
  language        String?
  position        String                 @default("head")
  priority        Int                    @default(0)
  conditionalLoad Boolean                @default(false)
  conditions      String?
  targetPages     String?
  excludePages    String?
  targetDevices   String?
  targetRoles     String?
  isScheduled     Boolean                @default(false)
  startDate       DateTime?
  endDate         DateTime?
  async           Boolean                @default(false)
  defer           Boolean                @default(false)
  preload         Boolean                @default(false)
  version         String                 @default("1.0.0")
  changelog       String?
  isTrusted       Boolean                @default(false)
  hashVerified    Boolean                @default(false)
  codeHash        String?
  isActive        Boolean                @default(true)
  isDevelopment   Boolean                @default(false)
  loadCount       Int                    @default(0)
  errorCount      Int                    @default(0)
  lastLoaded      DateTime?
  lastError       String?
  createdBy       String?
  updatedBy       String?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  dependents      CustomCodeDependency[] @relation("DependentCode")
  dependencies    CustomCodeDependency[] @relation("ParentCode")
  executions      CustomCodeExecution[]

  @@index([type])
  @@index([position])
  @@index([isActive])
  @@index([priority])
}

model CustomCodeDependency {
  id             String     @id @default(cuid())
  parentId       String
  dependentId    String
  dependencyType String     @default("requires")
  loadOrder      Int        @default(0)
  createdAt      DateTime   @default(now())
  dependent      CustomCode @relation("DependentCode", fields: [dependentId], references: [id], onDelete: Cascade)
  parent         CustomCode @relation("ParentCode", fields: [parentId], references: [id], onDelete: Cascade)

  @@unique([parentId, dependentId])
  @@index([parentId])
  @@index([dependentId])
}

model CustomCodeExecution {
  id            String     @id @default(cuid())
  codeId        String
  userId        String?
  sessionId     String?
  executionTime DateTime   @default(now())
  loadTime      Int?
  success       Boolean
  errorMessage  String?
  userAgent     String?
  ipAddress     String?
  pageUrl       String?
  deviceType    String?
  code          CustomCode @relation(fields: [codeId], references: [id], onDelete: Cascade)

  @@index([codeId])
  @@index([executionTime])
  @@index([success])
}

model CodeLibrary {
  id            String   @id @default(cuid())
  name          String   @unique
  displayName   String
  description   String?
  category      String   @default("utility")
  type          String
  code          String
  documentation String?
  configSchema  String?
  defaultConfig String?
  version       String   @default("1.0.0")
  author        String?
  license       String?
  tags          String?
  isPublic      Boolean  @default(false)
  isVerified    Boolean  @default(false)
  downloadCount Int      @default(0)
  createdBy     String?
  updatedBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([category])
  @@index([type])
  @@index([isPublic])
}

model GlobalScript {
  id              String   @id @default(cuid())
  name            String   @unique
  displayName     String
  scriptType      String
  provider        String?
  headCode        String?
  bodyStartCode   String?
  bodyEndCode     String?
  trackingId      String?
  apiKey          String?
  configuration   String?
  requiresConsent Boolean  @default(false)
  consentCategory String?
  loadOnPages     String?
  excludePages    String?
  userRoles       String?
  isActive        Boolean  @default(true)
  testMode        Boolean  @default(false)
  createdBy       String?
  updatedBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([scriptType])
  @@index([isActive])
}

model Page {
  id                 String   @id @default(cuid())
  slug               String   @unique
  title              String
  description        String?
  isPublished        Boolean  @default(false)
  unpublishedMessage String?  @default("페이지 준비 중입니다.")
  showInMenu         Boolean  @default(true)
  menuGroup          String?
  menuOrder          Int      @default(0)
  seoTitle           String?
  seoDescription     String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Member {
  id              String               @id @default(cuid())
  memberCode      String               @unique
  name            String
  birthYear       Int?
  birthDate       DateTime?
  gender          String?
  email           String?
  phone           String?
  kakaoId         String?
  organization    String?
  origin          String?
  hometown        String?
  residence       String?
  grade           String               @default("MEMBER")
  status          String               @default("ACTIVE")
  joinedAt        DateTime             @default(now())
  userId          String?              @unique
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  bookReports     BookReport[]
  reportComments  BookReportComment[]
  reportLikes     BookReportLike[]
  user            User?                @relation(fields: [userId], references: [id])
  attendances     MemberAttendance[]
  notes           MemberNote[]
  stats           MemberStats?
  statusLogs      MemberStatusLog[]
  applications    ProgramApplication[]
  refundHistories RefundHistory[]

  @@index([memberCode])
  @@index([email])
  @@index([phone])
  @@index([name, birthYear])
  @@index([status])
  @@index([grade])
}

model MemberStatusLog {
  id             String   @id @default(cuid())
  memberId       String
  previousStatus String?
  previousGrade  String?
  newStatus      String?
  newGrade       String?
  reason         String
  createdBy      String?
  createdAt      DateTime @default(now())
  member         Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([createdAt])
}

model MemberNote {
  id        String   @id @default(cuid())
  memberId  String
  content   String
  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
}

model MemberStats {
  id                 String    @id @default(cuid())
  memberId           String    @unique
  totalPrograms      Int       @default(0)
  totalSessions      Int       @default(0)
  totalBooks         Int       @default(0)
  totalAttended      Int       @default(0)
  totalAbsent        Int       @default(0)
  totalReports       Int       @default(0)
  attendanceRate     Float     @default(0)
  reportRate         Float     @default(0)
  noShowCount        Int       @default(0)
  lastParticipatedAt DateTime?
  updatedAt          DateTime  @updatedAt
  member             Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)
}

model MemberAttendance {
  id              String    @id @default(cuid())
  memberId        String
  programId       String
  sessionNumber   Int
  sessionDate     DateTime?
  attended        Boolean   @default(false)
  reportSubmitted Boolean   @default(false)
  note            String?
  createdAt       DateTime  @default(now())
  refundEligible  Boolean   @default(false)
  member          Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  program         Program   @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([memberId, programId, sessionNumber])
  @@index([memberId])
  @@index([programId])
}

model AdminNotification {
  id        String   @id @default(cuid())
  type      String
  title     String
  message   String
  data      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([type])
  @@index([read])
  @@index([createdAt])
}

model RefundHistory {
  id          String    @id @default(cuid())
  memberId    String
  programId   String
  amount      Int
  method      String?
  accountInfo String?
  status      String    @default("PENDING")
  processedBy String?
  processedAt DateTime?
  note        String?
  createdAt   DateTime  @default(now())
  member      Member    @relation(fields: [memberId], references: [id])
  program     Program   @relation(fields: [programId], references: [id])

  @@index([memberId])
  @@index([programId])
  @@index([status])
}

model ReadBook {
  id           String       @id @default(cuid())
  title        String
  author       String?
  publisher    String?
  pubYear      String?
  image        String?
  season       String
  sessionCount Int?
  participants Int?
  category     String?
  rating       Int?
  status       String       @default("COMPLETED")
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  bookReports    BookReport[]
  // Phase 6: 내 책장
  wishBooks      WishBook[]
  favoriteBooks  FavoriteBook[]

  @@index([season])
  @@index([category])
}

model BookReport {
  id               String                @id @default(cuid())
  bookId           String?
  title            String
  content          String
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  approvedAt       DateTime?
  approvedBy       String?
  authorId         String
  bookAuthor       String?
  bookTitle        String
  likeCount        Int                   @default(0)
  programId        String?
  publishedAt      DateTime?
  rating           Int?
  sessionId        String?
  status           String                @default("DRAFT")
  viewCount        Int                   @default(0)
  visibility       String                @default("PRIVATE")
  author           Member                @relation(fields: [authorId], references: [id], onDelete: Cascade)
  book             ReadBook?             @relation(fields: [bookId], references: [id])
  program          Program?              @relation(fields: [programId], references: [id])
  session          ProgramSession?       @relation(fields: [sessionId], references: [id])
  approver         User?                 @relation("BookReportApprover", fields: [approvedBy], references: [id])
  comments         BookReportComment[]
  likes            BookReportLike[]
  structuredReport StructuredBookReport?

  @@index([authorId])
  @@index([programId])
  @@index([visibility])
  @@index([status])
}

model BookReportLike {
  id        String     @id @default(cuid())
  reportId  String
  memberId  String
  createdAt DateTime   @default(now())
  member    Member     @relation(fields: [memberId], references: [id], onDelete: Cascade)
  report    BookReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@unique([reportId, memberId])
  @@index([reportId])
  @@index([memberId])
}

model BookReportComment {
  id        String              @id @default(cuid())
  reportId  String
  authorId  String
  content   String
  parentId  String?
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  author    Member              @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent    BookReportComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   BookReportComment[] @relation("CommentReplies")
  report    BookReport          @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([authorId])
}

model SurveyTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String
  isDefault   Boolean  @default(false)
  isPublic    Boolean  @default(true)
  createdBy   String?
  questions   String
  settings    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([isDefault])
}

// 독후감 템플릿
model ReportTemplate {
  id               String   @id @default(cuid())
  name             String
  code             String   @unique
  description      String?
  category         String
  icon             String?
  structure        String   // 기존 필드 유지
  fields           String?  // JSON 문자열로 저장 (SQLite 호환)
  estimatedMinutes Int      @default(20) // 예상 작성 시간
  isDefault        Boolean  @default(false)
  isActive         Boolean  @default(true)
  sortOrder        Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  sessionReports SessionReport[]

  @@index([code])
  @@index([category])
  @@index([isDefault])
}

// 세션별 독후감 (템플릿 기반)
model SessionReport {
  id          String          @id @default(cuid())
  sessionId   String
  userId      String
  templateId  String?
  content     String          // JSON 문자열로 저장 (SQLite 호환)
  status      String          @default("DRAFT") // DRAFT, SUBMITTED
  submittedAt DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  session  ProgramSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  template ReportTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@index([status])
}

// 구조화된 독후감
model StructuredBookReport {
  id        String     @id @default(cuid())
  reportId  String     @unique
  structure String
  sections  String
  report    BookReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([structure])
}

// ============================================
// Phase 13: 진행자 지원 + RSVP + 인센티브
// ============================================

// 프로그램 멤버십 (역할 구분: 운영진/참가자)
model ProgramMembership {
  id        String @id @default(cuid())
  programId String
  userId    String
  role      String // "ORGANIZER" (운영진), "PARTICIPANT" (참가자)

  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([programId, userId])
  @@index([programId])
  @@index([userId])
  @@index([role])
}

// 진행자 지원 (참가자가 신청)
model FacilitatorApplication {
  id        String  @id @default(cuid())
  sessionId String
  userId    String
  status    String  @default("PENDING") // PENDING, APPROVED, REJECTED
  message   String? // 지원 동기

  reviewedBy String? // 운영진 userId
  reviewedAt DateTime?
  reviewNote String?

  session ProgramSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@index([status])
}

// 세션별 진행자 (최종 배정)
model SessionFacilitator {
  id        String @id @default(cuid())
  sessionId String
  userId    String

  type       String // "ORGANIZER" (운영진), "VOLUNTEER" (참가자 지원)
  assignedBy String? // 배정한 운영진 userId
  note       String?

  // 인센티브 (참가자만)
  incentiveGranted Boolean @default(false)
  incentiveType    String? // "ATTENDANCE" | "REPORT"
  incentiveApplied Boolean @default(false)

  session   ProgramSession        @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  checklist FacilitatorChecklist?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@index([type])
}

// 진행자 준비 체크리스트 템플릿
model FacilitatorChecklistTemplate {
  id        String @id @default(cuid())
  programId String @unique

  items      String // JSON: 체크리스트 항목 배열
  isRequired Boolean @default(false) // 권장사항 or 필수

  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 진행자별 체크리스트 상태
model FacilitatorChecklist {
  id            String @id @default(cuid())
  facilitatorId String @unique

  completedItems String // JSON: 완료한 항목 ID 배열
  progress       Int    @default(0) // 완료율 (%)

  facilitator SessionFacilitator @relation(fields: [facilitatorId], references: [id], onDelete: Cascade)

  updatedAt DateTime @updatedAt
}

// 참석 확인 (RSVP)
model SessionRSVP {
  id             String    @id @default(cuid())
  sessionId      String
  userId         String
  status         String    @default("PENDING") // PENDING, ATTENDING, NOT_ATTENDING, MAYBE
  respondedAt    DateTime?
  note           String?
  reminderSentAt DateTime?

  session ProgramSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@index([status])
}

// ============================================
// Phase 14: 발언자별 타이머 + 통계
// ============================================

// 참가자별 발언 시간 기록
model SpeakingTime {
  id        String  @id @default(cuid())
  sessionId String
  userId    String
  duration  Int     @default(0) // 초 단위
  isActive  Boolean @default(false) // 현재 발언 중

  session ProgramSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  updatedAt DateTime @updatedAt

  @@unique([sessionId, userId])
  @@index([sessionId])
}

// 세션별 발언 통계 요약
model SessionSpeakingStats {
  id                  String  @id @default(cuid())
  sessionId           String  @unique
  totalSpeakingTime   Int     @default(0) // 총 발언 시간 (초)
  averageSpeakingTime Int     @default(0) // 평균 발언 시간 (초)
  participantCount    Int     @default(0) // 발언한 참가자 수
  balanceScore        Int     @default(0) // 발언 균형도 점수 (0-100)
  topSpeakers         String? // JSON: 상위 발언자 [{userId, duration, percentage}]
  silentParticipants  String? // JSON: 발언하지 않은 참가자 userId 배열

  session ProgramSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  updatedAt DateTime @updatedAt
}

// ============================================
// Phase 15: AI 모임 준비 어시스턴트
// ============================================

// AI 대화 기록
model AIConversation {
  id        String  @id @default(cuid())
  sessionId String
  userId    String // 진행자
  messages  String // JSON: 대화 메시지 배열
  context   String? // JSON: 분석 컨텍스트

  session ProgramSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
}

// AI 생성 토론 질문
model AIGeneratedQuestion {
  id        String    @id @default(cuid())
  sessionId String
  question  String
  category  String // "INTRO", "DEEP", "APPLICATION"
  reasoning String? // AI가 이 질문을 제안한 이유
  basedOn   String? // JSON: 기반이 된 독후감/데이터
  isUsed    Boolean   @default(false)
  usedAt    DateTime?

  session ProgramSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([sessionId])
}

// ============================================
// Phase 16: 공지/알림 시스템
// ============================================

// 세션 공지
model SessionAnnouncement {
  id            String    @id @default(cuid())
  sessionId     String
  type          String // "TWO_WEEKS", "ONE_WEEK", "ONE_DAY"
  title         String?
  content       String // 공지 내용
  isAIGenerated Boolean   @default(false)
  aiStyle       String? // JSON: {tone, emoji, length}
  isSent        Boolean   @default(false)
  sentAt        DateTime?
  sentBy        String?

  session ProgramSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([sessionId, type])
}

// 공지 템플릿
model AnnouncementTemplate {
  id       String  @id @default(cuid())
  userId   String
  name     String
  content  String // 템플릿 (변수 포함)
  style    String? // JSON
  isPublic Boolean @default(false)
  useCount Int     @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

// 알림 설정
model NotificationSettings {
  id                 String  @id @default(cuid())
  userId             String  @unique
  oneWeekEnabled     Boolean @default(true)
  facilitatorEnabled Boolean @default(true)
  rsvpEnabled        Boolean @default(true)
  reportEnabled      Boolean @default(true)
  quietHoursStart    Int     @default(22) // 22:00
  quietHoursEnd      Int     @default(8) // 08:00

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// Phase 17: 클로바노트 녹음 → 블로그
// ============================================

// 세션 녹음
model SessionRecording {
  id               String  @id @default(cuid())
  sessionId        String
  originalFileName String
  originalFileUrl  String
  uploadedBy       String
  transcriptRaw    String?
  transcriptClean  String?
  removedContent   String? // JSON: 제거된 내용

  session  ProgramSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  blogPost SessionBlogPost?

  createdAt DateTime @default(now())

  @@index([sessionId])
}

// 블로그 포스트
model SessionBlogPost {
  id          String    @id @default(cuid())
  recordingId String    @unique
  title       String
  content     String // 마크다운
  excerpt     String?
  status      String    @default("DRAFT")
  publishedAt DateTime?
  keywords    String? // JSON
  categories  String? // JSON
  shareUrl    String?

  recording SessionRecording @relation(fields: [recordingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

// ============================================
// Phase 18: 배지 시스템 + 개인 프로필
// ============================================

// 배지 정의
model Badge {
  id          String @id @default(cuid())
  code        String @unique
  name        String
  description String
  icon        String
  category    String // "ATTENDANCE", "REPORT", "FACILITATOR", "SPEAKING"
  condition   String // JSON: 획득 조건

  userBadges UserBadge[]

  createdAt DateTime @default(now())
}

// 사용자 획득 배지
model UserBadge {
  id        String  @id @default(cuid())
  userId    String
  badgeId   String
  programId String? // 어느 프로그램에서 획득

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  earnedAt DateTime @default(now())

  @@unique([userId, badgeId])
}

// 사용자 프로필 (통계)
model UserProfile {
  id                  String  @id @default(cuid())
  userId              String  @unique
  level               Int     @default(1)
  xp                  Int     @default(0)
  totalPrograms       Int     @default(0)
  totalBooks          Int     @default(0)
  totalFacilitated    Int     @default(0)
  attendanceRate      Int     @default(0)
  reportRate          Int     @default(0)
  averageSpeakingTime Int     @default(0)
  favoriteGenres      String? // JSON
  topKeywords         String? // JSON

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  updatedAt DateTime @updatedAt
}

// ============================================
// Phase 19: 모임 기록 아카이브
// ============================================

// 세션 아카이브
model SessionArchive {
  id                 String  @id @default(cuid())
  sessionId          String  @unique
  summary            String? // 모임 요약
  highlights         String? // JSON: 토론 하이라이트
  photos             String? // JSON: 사진 URL 배열
  topKeywords        String? // JSON
  nextSessionPreview String? // 다음 회차 예고

  session ProgramSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

// ============================================
// Phase 20: 책 읽기 도우미
// ============================================

// 읽기 진도
model ReadingProgress {
  id          String @id @default(cuid())
  userId      String
  sessionId   String
  currentPage Int    @default(0)
  totalPages  Int
  percentage  Int    @default(0)

  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  session ProgramSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  lastReadAt DateTime @default(now())

  @@unique([userId, sessionId])
}

// 하이라이트
model Highlight {
  id             String  @id @default(cuid())
  userId         String
  sessionId      String
  text           String
  page           Int
  note           String?
  photoUrl       String? // OCR 원본 사진
  isUsedInReport Boolean @default(false)

  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  session ProgramSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

// ============================================
// Phase 21: 참가자 평가 시스템 (운영진)
// ============================================

// 참가자 경고/칭찬 기록
model ParticipantCard {
  id          String  @id @default(cuid())
  programId   String
  userId      String
  type        String // "WARNING", "PRAISE"
  category    String // "ATTENDANCE", "REPORT", "ATTITUDE", "CONTRIBUTION"
  title       String
  description String?
  sessionId   String? // 특정 세션 관련
  issuedBy    String // 운영진 ID

  program Program         @relation(fields: [programId], references: [id], onDelete: Cascade)
  user    User            @relation("ReceivedCards", fields: [userId], references: [id])
  issuer  User            @relation("IssuedCards", fields: [issuedBy], references: [id])
  session ProgramSession? @relation(fields: [sessionId], references: [id])

  createdAt DateTime @default(now())

  @@index([programId, userId])
  @@index([type])
}

// 운영진 메모
model OrganizerNote {
  id        String  @id @default(cuid())
  programId String
  userId    String // 대상 참가자
  content   String
  isPrivate Boolean @default(true) // 항상 비공개
  createdBy String

  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)
  user    User    @relation("ReceivedNotes", fields: [userId], references: [id])
  creator User    @relation("CreatedNotes", fields: [createdBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([programId, userId])
}

// 시즌 종료 종합 평가
model SeasonEvaluation {
  id                 String  @id @default(cuid())
  programId          String
  userId             String
  overallRating      Int // 1-5
  participationScore Int // 1-5
  preparationScore   Int // 1-5
  cooperationScore   Int // 1-5
  contributionScore  Int // 1-5
  strengths          String? // 강점
  improvements       String? // 개선 필요
  recommendation     String // "PRIORITY", "WELCOME", "HOLD", "RESTRICT"
  evaluatedBy        String

  program   Program @relation(fields: [programId], references: [id], onDelete: Cascade)
  user      User    @relation("ReceivedEvaluations", fields: [userId], references: [id])
  evaluator User    @relation("CreatedEvaluations", fields: [evaluatedBy], references: [id])

  createdAt DateTime @default(now())

  @@unique([programId, userId])
  @@index([recommendation])
}

// 다음 시즌 참여 권한
model ParticipationPermission {
  id        String    @id @default(cuid())
  userId    String
  programId String? // null = 전체, 특정 ID = 해당 프로그램만
  status    String // "ALLOWED", "RESTRICTED", "BANNED"
  reason    String?
  expiresAt DateTime?
  setBy     String

  user    User     @relation("ParticipationPermissions", fields: [userId], references: [id])
  program Program? @relation(fields: [programId], references: [id])
  admin   User     @relation("SetPermissions", fields: [setBy], references: [id])

  createdAt DateTime @default(now())

  @@index([userId, status])
}

// ============================================
// Phase 22: 결석 신청 시스템
// ============================================

// 결석 신청
model AbsenceRequest {
  id            String   @id @default(cuid())
  sessionId     String
  participantId String
  userId        String
  reason        String   // 결석 사유
  attachment    String?  // 증빙 자료 URL
  status        String   @default("PENDING") // PENDING, APPROVED, REJECTED

  reviewedBy    String?
  reviewedAt    DateTime?
  reviewNote    String?  // 승인/반려 메모

  session     ProgramSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  participant ProgramParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewer    User?              @relation("AbsenceReviewer", fields: [reviewedBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, participantId])
  @@index([sessionId])
  @@index([participantId])
  @@index([status])
}

// Phase 6: 내 책장 - 읽고 싶은 책
model WishBook {
  id          String    @id @default(cuid())

  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  readBookId  String?
  readBook    ReadBook? @relation(fields: [readBookId], references: [id])

  customTitle  String?
  customAuthor String?

  memo        String?

  createdAt   DateTime  @default(now())

  @@unique([userId, readBookId])
  @@index([userId])
}

// Phase 6: 내 책장 - 인생 책
model FavoriteBook {
  id           String   @id @default(cuid())

  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  readBookId   String
  readBook     ReadBook @relation(fields: [readBookId], references: [id])

  comment      String?
  displayOrder Int      @default(0)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, readBookId])
  @@index([userId])
}

// ============================================
// Phase 8: 명문장 (Quotes)
// ============================================

model Quote {
  id         String   @id @default(cuid())
  userId     String
  bookTitle  String
  bookAuthor String?
  content    String
  page       Int?
  memo       String?
  isPublic   Boolean  @default(true)
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}
