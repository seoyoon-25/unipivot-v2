generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================
// NextAuth.js 모델
// =============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  phone         String?
  origin        String?   // SOUTH, NORTH, OVERSEAS
  birthYear     Int?
  occupation    String?
  bio           String?
  points        Int       @default(0)
  role          String    @default("USER") // USER, ADMIN, SUPER_ADMIN
  status        String    @default("ACTIVE") // ACTIVE, INACTIVE, BANNED
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts            Account[]
  sessions            Session[]
  registrations       Registration[]
  bookReports         BookReport[]
  donations           Donation[]
  deposits            Deposit[]
  chatLogs            ChatLog[]
  notifications       Notification[]
  activityLogs        ActivityLog[]
  talents             Talent[]
  blogPosts           BlogPost[]
  pointHistory        PointHistory[]
  programApplications ProgramApplication[]
  programParticipants ProgramParticipant[]
  programReports      ProgramReport[]
  reportComments      ReportComment[]
  reportLikes         ReportLike[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// =============================================
// 프로그램 관련 모델
// =============================================

model Program {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  type        String   // BOOKCLUB, SEMINAR, WORKSHOP, KMOVE, OTHER
  description String?
  content     String?
  image       String?
  capacity    Int      @default(30)
  fee         Int      @default(0)
  location    String?
  isOnline    Boolean  @default(false)
  status      String   @default("DRAFT") // DRAFT, OPEN, CLOSED, COMPLETED
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sessions       ProgramSession[]
  registrations  Registration[]
  books          BookOnProgram[]
  applications   ProgramApplication[]
  gallery        ProgramGallery[]
  depositSetting DepositSetting?
  participants   ProgramParticipant[]
  programReports ProgramReport[]
}

model Registration {
  id        String   @id @default(cuid())
  userId    String
  programId String
  status    String   @default("PENDING") // PENDING, APPROVED, REJECTED, CANCELLED
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([userId, programId])
}

// =============================================
// 포인트 내역 모델
// =============================================

model PointHistory {
  id          String   @id @default(cuid())
  userId      String
  amount      Int      // 양수: 적립, 음수: 사용
  type        String   // EARN, SPEND
  category    String   // ATTENDANCE, REPORT, DONATION, PROGRAM, EVENT, EXCHANGE, OTHER
  description String
  balance     Int      // 거래 후 잔액
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// =============================================
// 도서 관련 모델
// =============================================

model Book {
  id        String   @id @default(cuid())
  title     String
  author    String?
  publisher String?
  isbn      String?
  image     String?
  summary   String?
  createdAt DateTime @default(now())

  programs BookOnProgram[]
  reports  BookReport[]
}

model BookOnProgram {
  id        String   @id @default(cuid())
  bookId    String
  programId String
  week      Int?
  createdAt DateTime @default(now())

  book    Book    @relation(fields: [bookId], references: [id], onDelete: Cascade)
  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([bookId, programId])
}

model BookReport {
  id        String   @id @default(cuid())
  userId    String
  bookId    String
  title     String
  content   String
  isPublic  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)
}

// =============================================
// 사업 관리 모델
// =============================================

model Project {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String   @default("PLANNING") // PLANNING, IN_PROGRESS, COMPLETED, ON_HOLD
  budget      Int?
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  milestones Milestone[]
  partners   PartnerOnProject[]
  documents  Document[]
  events     CalendarEvent[]
}

model Milestone {
  id          String    @id @default(cuid())
  projectId   String
  title       String
  description String?
  dueDate     DateTime?
  status      String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  createdAt   DateTime  @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Partner {
  id          String   @id @default(cuid())
  name        String
  type        String?  // GOVERNMENT, CORPORATION, NGO, ACADEMIC, OTHER
  contact     String?
  email       String?
  phone       String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  projects PartnerOnProject[]
}

model PartnerOnProject {
  id        String   @id @default(cuid())
  partnerId String
  projectId String
  role      String?
  createdAt DateTime @default(now())

  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([partnerId, projectId])
}

model Document {
  id        String   @id @default(cuid())
  projectId String?
  title     String
  type      String?  // PROPOSAL, REPORT, CONTRACT, MEETING, OTHER
  filePath  String?
  fileSize  Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
}

model CalendarEvent {
  id          String    @id @default(cuid())
  projectId   String?
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime?
  allDay      Boolean   @default(false)
  location    String?
  type        String?   // MEETING, DEADLINE, EVENT, OTHER
  createdAt   DateTime  @default(now())

  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
}

// =============================================
// 재무 관련 모델
// =============================================

model Transaction {
  id          String   @id @default(cuid())
  type        String   // INCOME, EXPENSE
  category    String?  // DONATION, PROGRAM_FEE, GRANT, SALARY, RENT, SUPPLIES, OTHER
  amount      Int
  description String?
  date        DateTime
  receipt     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Deposit {
  id        String   @id @default(cuid())
  userId    String?
  amount    Int
  purpose   String?  // PROGRAM_FEE, MEMBERSHIP, OTHER
  status    String   @default("PENDING") // PENDING, CONFIRMED, REFUNDED
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model Donation {
  id        String   @id @default(cuid())
  userId    String?
  amount    Int
  type      String?  // ONE_TIME, MONTHLY
  method    String?  // BANK_TRANSFER, CARD, OTHER
  message   String?
  anonymous Boolean  @default(false)
  status    String   @default("PENDING") // PENDING, COMPLETED, CANCELLED
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}

// =============================================
// 전문가/재능 기부 모델
// =============================================

model Expert {
  id           String   @id @default(cuid())
  name         String
  title        String?
  organization String?
  field        String?
  bio          String?
  image        String?
  email        String?
  phone        String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Talent {
  id          String   @id @default(cuid())
  userId      String
  title       String
  category    String?  // DESIGN, DEVELOPMENT, TRANSLATION, MARKETING, OTHER
  description String?
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// =============================================
// AI 챗봇 모델
// =============================================

model ChatLog {
  id        String   @id @default(cuid())
  userId    String?
  sessionId String
  role      String   // USER, ASSISTANT
  content   String
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model KnowledgeBase {
  id        String   @id @default(cuid())
  category  String   // FAQ, PROGRAM, ORGANIZATION, OTHER
  question  String
  answer    String
  keywords  String?
  priority  Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =============================================
// 콘텐츠 관리 모델
// =============================================

model Notice {
  id        String   @id @default(cuid())
  title     String
  content   String
  isPinned  Boolean  @default(false)
  isPublic  Boolean  @default(true)
  views     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlogPost {
  id          String   @id @default(cuid())
  authorId    String
  title       String
  slug        String   @unique
  excerpt     String?
  content     String
  image       String?
  category    String?
  tags        String?
  isPublished Boolean  @default(false)
  views       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

// =============================================
// CMS 모델
// =============================================

model PageContent {
  id          String   @id @default(cuid())
  parentId    String?  // 부모 페이지 ID (null = 최상위)
  slug        String   @unique
  title       String
  content     String?  // HTML content
  styles      String?  // CSS styles
  components  String?  // GrapesJS JSON data
  metaTitle   String?
  metaDesc    String?
  isFolder    Boolean  @default(false)  // 폴더 여부
  order       Int      @default(0)       // 정렬 순서
  isPublished Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  parent      PageContent?  @relation("PageHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    PageContent[] @relation("PageHierarchy")
}

model Menu {
  id        String   @id @default(cuid())
  parentId  String?
  title     String
  url       String?
  target    String?  @default("_self")
  position  Int      @default(0)
  isActive  Boolean  @default(true)
  location  String?  // HEADER, FOOTER
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SiteSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String?
  type      String?  // TEXT, NUMBER, BOOLEAN, JSON, IMAGE
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Banner {
  id        String    @id @default(cuid())
  title     String
  subtitle  String?
  image     String?
  link      String?
  position  String?   // HERO, SIDEBAR, POPUP
  isActive  Boolean   @default(true)
  startDate DateTime?
  endDate   DateTime?
  order     Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// =============================================
// 시스템 모델
// =============================================

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  target    String?
  targetId  String?
  details   String?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // SYSTEM, PROGRAM, PAYMENT, OTHER
  title     String
  content   String?
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailLog {
  id        String   @id @default(cuid())
  to        String
  subject   String
  content   String?
  status    String   @default("SENT") // SENT, FAILED
  error     String?
  createdAt DateTime @default(now())
}

// =============================================
// NGO 회계 시스템 모델
// =============================================

model FiscalYear {
  id        String   @id @default(cuid())
  year      Int      @unique
  startDate DateTime
  endDate   DateTime
  isCurrent Boolean  @default(false)
  isClosed  Boolean  @default(false)
  createdAt DateTime @default(now())

  budgets Budget[]
}

model FinanceAccount {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  type        String   // INCOME, EXPENSE, ASSET, LIABILITY
  category    String
  subcategory String?
  description String?
  isActive    Boolean  @default(true)
  isSystem    Boolean  @default(false)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  transactions FinanceTransaction[]
  budgetItems  BudgetItem[]
}

model Fund {
  id               String   @id @default(cuid())
  name             String
  type             String   // GENERAL, PROJECT
  description      String?
  financeProjectId String?
  balance          Int      @default(0)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())

  financeProject FinanceProject? @relation(fields: [financeProjectId], references: [id])
  transactions   FinanceTransaction[]
  budgets        Budget[]
}

model FinanceProject {
  id              String    @id @default(cuid())
  name            String
  funder          String
  contractNumber  String?
  totalBudget     Int
  startDate       DateTime
  endDate         DateTime
  status          String    @default("PLANNING") // PLANNING, ACTIVE, SETTLEMENT, CLOSED
  settlementDates String?   // JSON array
  description     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  funds       Fund[]
  budgetItems ProjectBudgetItem[]
  documents   ProjectDocument[]
}

model ProjectBudgetItem {
  id               String  @id @default(cuid())
  financeProjectId String
  category         String
  subcategory      String?
  item             String
  budget           Int
  executed         Int     @default(0)
  note             String?
  sortOrder        Int     @default(0)

  financeProject FinanceProject @relation(fields: [financeProjectId], references: [id], onDelete: Cascade)
}

model ProjectDocument {
  id               String   @id @default(cuid())
  financeProjectId String
  type             String   // CONTRACT, REPORT, SETTLEMENT, OTHER
  name             String
  fileUrl          String
  uploadedAt       DateTime @default(now())
  uploadedBy       String?

  financeProject FinanceProject @relation(fields: [financeProjectId], references: [id], onDelete: Cascade)
}

model FinanceTransaction {
  id                  String   @id @default(cuid())
  date                DateTime
  type                String   // INCOME, EXPENSE
  fundId              String
  financeAccountId    String
  amount              Int
  description         String
  vendor              String?
  paymentMethod       String?  // CASH, CARD, TRANSFER
  projectBudgetItemId String?
  receiptId           String?
  evidenceType        String?  // TAX_INVOICE, CASH_RECEIPT, CARD_SLIP, SIMPLE, NONE
  depositType         String?  // DEPOSIT_IN, DEPOSIT_RETURN, DEPOSIT_FORFEIT
  participantId       String?
  note                String?
  createdBy           String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  fund           Fund           @relation(fields: [fundId], references: [id])
  financeAccount FinanceAccount @relation(fields: [financeAccountId], references: [id])
  receipt        Receipt?       @relation(fields: [receiptId], references: [id])
}

model Receipt {
  id           String   @id @default(cuid())
  imageUrl     String
  thumbnailUrl String?
  ocrData      String?  // JSON
  ocrStatus    String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  date         DateTime?
  amount       Int?
  vendor       String?
  status       String   @default("PENDING") // PENDING, MATCHED, ARCHIVED
  uploadedBy   String?
  uploadedAt   DateTime @default(now())

  transactions FinanceTransaction[]
}

model Budget {
  id           String    @id @default(cuid())
  fundId       String
  fiscalYearId String
  status       String    @default("DRAFT") // DRAFT, APPROVED, CLOSED
  totalAmount  Int       @default(0)
  approvedAt   DateTime?
  approvedBy   String?
  createdAt    DateTime  @default(now())

  fund       Fund       @relation(fields: [fundId], references: [id])
  fiscalYear FiscalYear @relation(fields: [fiscalYearId], references: [id])
  items      BudgetItem[]
}

model BudgetItem {
  id               String @id @default(cuid())
  budgetId         String
  financeAccountId String
  amount           Int
  executed         Int    @default(0)
  note             String?

  budget         Budget         @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  financeAccount FinanceAccount @relation(fields: [financeAccountId], references: [id])
}

model FinanceDonation {
  id              String    @id @default(cuid())
  donorId         String?
  donorName       String
  donorType       String    @default("INDIVIDUAL") // INDIVIDUAL, CORPORATE
  amount          Int
  date            DateTime
  type            String    @default("ONETIME") // REGULAR, ONETIME, DESIGNATED
  designation     String?
  receiptIssued   Boolean   @default(false)
  receiptNumber   String?
  receiptIssuedAt DateTime?
  note            String?
  createdAt       DateTime  @default(now())

  donor Donor? @relation(fields: [donorId], references: [id])
}

model Donor {
  id            String    @id @default(cuid())
  name          String
  type          String    @default("INDIVIDUAL") // INDIVIDUAL, CORPORATE
  residentId    String?   // 암호화
  businessId    String?
  phone         String?
  email         String?
  address       String?
  totalDonation Int       @default(0)
  donationCount Int       @default(0)
  lastDonationAt DateTime?
  createdAt     DateTime  @default(now())

  donations FinanceDonation[]
}

// =============================================
// NGO 프로그램 관리 확장 모델
// =============================================

model ProgramApplication {
  id          String    @id @default(cuid())
  programId   String
  userId      String
  status      String    @default("PENDING") // PENDING, CONFIRMED, CANCELLED, REJECTED
  appliedAt   DateTime  @default(now())
  confirmedAt DateTime?
  cancelledAt DateTime?
  cancelReason String?
  note        String?

  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@unique([programId, userId])
}

model ProgramGallery {
  id         String   @id @default(cuid())
  programId  String
  imageUrl   String
  caption    String?
  sortOrder  Int      @default(0)
  uploadedAt DateTime @default(now())

  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)
}

model DepositSetting {
  id              String    @id @default(cuid())
  programId       String    @unique
  isEnabled       Boolean   @default(true)
  totalSessions   Int
  depositAmount   Int
  conditionType   String    // ATTENDANCE_ONLY, ATTENDANCE_AND_REPORT
  attendanceRate  Int       @default(80)
  reportRate      Int?
  status          String    @default("ACTIVE") // ACTIVE, SETTLING, SETTLED
  settledAt       DateTime?
  settledBy       String?
  totalDeposits   Int       @default(0)
  totalReturned   Int       @default(0)
  totalForfeited  Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)
}

model ProgramParticipant {
  id                    String    @id @default(cuid())
  programId             String
  userId                String
  status                String    @default("ACTIVE") // ACTIVE, DROPPED, COMPLETED
  joinedAt              DateTime  @default(now())
  depositAmount         Int       @default(0)
  depositPaidAt         DateTime?
  depositStatus         String    @default("NONE") // NONE, UNPAID, PAID, RETURNED, FORFEITED, CARRIED
  finalAttendanceRate   Float?
  finalReportRate       Float?
  returnAmount          Int?
  forfeitAmount         Int?
  returnMethod          String?   // TRANSFER, CARRY_OVER, CASH
  settledAt             DateTime?
  settleNote            String?
  depositTransactionId  String?
  returnTransactionId   String?
  forfeitTransactionId  String?

  program     Program               @relation(fields: [programId], references: [id], onDelete: Cascade)
  user        User                  @relation(fields: [userId], references: [id])
  attendances ProgramAttendance[]
  reports     ProgramReport[]

  @@unique([programId, userId])
}

model ProgramSession {
  id             String    @id @default(cuid())
  programId      String
  sessionNo      Int
  date           DateTime
  startTime      String?
  endTime        String?
  title          String?
  bookTitle      String?
  bookRange      String?
  location       String?
  description    String?
  qrCode         String?   @unique
  qrExpiresAt    DateTime?
  reportDeadline DateTime?
  status         String    @default("SCHEDULED") // SCHEDULED, ONGOING, COMPLETED, CANCELLED
  createdAt      DateTime  @default(now())

  program     Program             @relation(fields: [programId], references: [id], onDelete: Cascade)
  attendances ProgramAttendance[]
  reports     ProgramReport[]

  @@unique([programId, sessionNo])
}

model ProgramAttendance {
  id            String    @id @default(cuid())
  sessionId     String
  participantId String
  status        String    @default("ABSENT") // PRESENT, ABSENT, LATE, EXCUSED
  checkedAt     DateTime?
  checkMethod   String?   // QR, MANUAL
  note          String?

  session     ProgramSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  participant ProgramParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([sessionId, participantId])
}

model ProgramReport {
  id            String    @id @default(cuid())
  sessionId     String
  participantId String
  userId        String
  programId     String
  title         String
  content       String
  charCount     Int       @default(0)
  photoUrl      String?
  question      String?
  status        String    @default("DRAFT") // DRAFT, SUBMITTED
  submittedAt   DateTime?
  visibility    String    @default("PARTICIPANTS") // PARTICIPANTS, PUBLIC
  viewCount     Int       @default(0)
  likeCount     Int       @default(0)
  commentCount  Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  session     ProgramSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  participant ProgramParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  user        User               @relation(fields: [userId], references: [id])
  program     Program            @relation(fields: [programId], references: [id], onDelete: Cascade)
  comments    ReportComment[]
  likes       ReportLike[]

  @@unique([sessionId, participantId])
}

model ReportComment {
  id        String   @id @default(cuid())
  reportId  String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  report ProgramReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  user   User          @relation(fields: [userId], references: [id])
}

model ReportLike {
  id        String   @id @default(cuid())
  reportId  String
  userId    String
  createdAt DateTime @default(now())

  report ProgramReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  user   User          @relation(fields: [userId], references: [id])

  @@unique([reportId, userId])
}
