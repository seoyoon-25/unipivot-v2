generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================
// NextAuth.js 모델
// =============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  phone         String?
  origin        String?   // SOUTH, NORTH, OVERSEAS (기존 호환)
  originCategory String?  // DEFECTOR, MARRIAGE_IMMIGRANT, MIGRANT_WORKER, INTERNATIONAL_STUDENT, REFUGEE, OVERSEAS_KOREAN, MULTICULTURAL_CHILD, NATURALIZED, KOREAN
  originCountry String?   // 출신 국가 코드
  originDetails String?   @db.Text // JSON: 카테고리별 상세 정보
  arrivalYear   Int?      // 입국년도
  birthYear     Int?
  occupation    String?
  bio           String?
  points        Int       @default(0)
  role          String    @default("USER") // USER, ADMIN, SUPER_ADMIN
  status        String    @default("ACTIVE") // ACTIVE, INACTIVE, BANNED
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts            Account[]
  sessions            Session[]
  registrations       Registration[]
  bookReports         BookReport[]
  donations           Donation[]
  deposits            Deposit[]
  chatLogs            ChatLog[]
  notifications       Notification[]
  activityLogs        ActivityLog[]
  talents             Talent[]
  blogPosts           BlogPost[]
  pointHistory        PointHistory[]
  programApplications ProgramApplication[]
  programParticipants ProgramParticipant[]
  programReports      ProgramReport[]
  reportComments      ReportComment[]
  reportLikes         ReportLike[]
  programLikes        ProgramLike[]
  // 관심사 시스템 관계
  interests           Interest[]
  interestLikes       InterestLike[]
  interestKeywordLikes InterestKeywordLike[]
  interestAlerts      InterestAlert[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// =============================================
// 프로그램 관련 모델
// =============================================

model Program {
  id                String    @id @default(cuid())
  title             String
  slug              String    @unique
  type              String    // BOOKCLUB, SEMINAR, KMOVE, DEBATE, WORKSHOP, OTHER
  description       String?
  content           String?
  image             String?
  thumbnailSquare   String?   // 정사각형 썸네일
  capacity          Int       @default(30)
  fee               Int       @default(0)
  feeType           String    @default("FREE") // FREE, DEPOSIT, FEE, TUITION
  feeAmount         Int       @default(0)
  location          String?
  isOnline          Boolean   @default(false)
  status            String    @default("DRAFT") // DRAFT, RECRUITING, RECRUIT_CLOSED, ONGOING, COMPLETED
  recruitStartDate  DateTime? // 모집 시작일
  recruitEndDate    DateTime? // 모집 마감일
  startDate         DateTime?
  endDate           DateTime?
  applicationFormId String?   // 커스텀 신청서 양식
  likeCount         Int       @default(0)
  applicationCount  Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  sessions        ProgramSession[]
  registrations   Registration[]
  books           BookOnProgram[]
  applications    ProgramApplication[]
  gallery         ProgramGallery[]
  depositSetting  DepositSetting?
  participants    ProgramParticipant[]
  programReports  ProgramReport[]
  likes           ProgramLike[]
  applicationForm ApplicationForm? @relation(fields: [applicationFormId], references: [id])
}

model Registration {
  id        String   @id @default(cuid())
  userId    String
  programId String
  status    String   @default("PENDING") // PENDING, APPROVED, REJECTED, CANCELLED
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([userId, programId])
}

// =============================================
// 포인트 내역 모델
// =============================================

model PointHistory {
  id          String   @id @default(cuid())
  userId      String
  amount      Int      // 양수: 적립, 음수: 사용
  type        String   // EARN, SPEND
  category    String   // ATTENDANCE, REPORT, DONATION, PROGRAM, EVENT, EXCHANGE, OTHER
  description String
  balance     Int      // 거래 후 잔액
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// =============================================
// 도서 관련 모델
// =============================================

model Book {
  id        String   @id @default(cuid())
  title     String
  author    String?
  publisher String?
  isbn      String?
  image     String?
  summary   String?
  createdAt DateTime @default(now())

  programs BookOnProgram[]
  reports  BookReport[]
}

model BookOnProgram {
  id        String   @id @default(cuid())
  bookId    String
  programId String
  week      Int?
  createdAt DateTime @default(now())

  book    Book    @relation(fields: [bookId], references: [id], onDelete: Cascade)
  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([bookId, programId])
}

model BookReport {
  id        String   @id @default(cuid())
  userId    String
  bookId    String
  title     String
  content   String
  isPublic  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)
}

// =============================================
// 사업 관리 모델
// =============================================

model Project {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String   @default("PLANNING") // PLANNING, IN_PROGRESS, COMPLETED, ON_HOLD
  budget      Int?
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  milestones Milestone[]
  partners   PartnerOnProject[]
  documents  Document[]
  events     CalendarEvent[]
}

model Milestone {
  id          String    @id @default(cuid())
  projectId   String
  title       String
  description String?
  dueDate     DateTime?
  status      String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  createdAt   DateTime  @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Partner {
  id          String   @id @default(cuid())
  name        String
  type        String?  // GOVERNMENT, CORPORATION, NGO, ACADEMIC, OTHER
  contact     String?
  email       String?
  phone       String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  projects PartnerOnProject[]
}

model PartnerOnProject {
  id        String   @id @default(cuid())
  partnerId String
  projectId String
  role      String?
  createdAt DateTime @default(now())

  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([partnerId, projectId])
}

model Document {
  id        String   @id @default(cuid())
  projectId String?
  title     String
  type      String?  // PROPOSAL, REPORT, CONTRACT, MEETING, OTHER
  filePath  String?
  fileSize  Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
}

model CalendarEvent {
  id          String    @id @default(cuid())
  projectId   String?
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime?
  allDay      Boolean   @default(false)
  location    String?
  type        String?   // MEETING, DEADLINE, EVENT, OTHER
  createdAt   DateTime  @default(now())

  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
}

// =============================================
// 재무 관련 모델
// =============================================

model Transaction {
  id          String   @id @default(cuid())
  type        String   // INCOME, EXPENSE
  category    String?  // DONATION, PROGRAM_FEE, GRANT, SALARY, RENT, SUPPLIES, OTHER
  amount      Int
  description String?
  date        DateTime
  receipt     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Deposit {
  id        String   @id @default(cuid())
  userId    String?
  amount    Int
  purpose   String?  // PROGRAM_FEE, MEMBERSHIP, OTHER
  status    String   @default("PENDING") // PENDING, CONFIRMED, REFUNDED
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model Donation {
  id        String   @id @default(cuid())
  userId    String?
  amount    Int
  type      String?  // ONE_TIME, MONTHLY
  method    String?  // BANK_TRANSFER, CARD, OTHER
  message   String?
  anonymous Boolean  @default(false)
  status    String   @default("PENDING") // PENDING, COMPLETED, CANCELLED
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}

// =============================================
// 전문가/재능 기부 모델
// =============================================

model Expert {
  id           String   @id @default(cuid())
  name         String
  title        String?
  organization String?
  field        String?
  bio          String?
  image        String?
  email        String?
  phone        String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Talent {
  id          String   @id @default(cuid())
  userId      String
  title       String
  category    String?  // DESIGN, DEVELOPMENT, TRANSLATION, MARKETING, OTHER
  description String?
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// =============================================
// AI 챗봇 모델
// =============================================

model ChatLog {
  id        String   @id @default(cuid())
  userId    String?
  sessionId String
  role      String   // USER, ASSISTANT
  content   String
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model KnowledgeBase {
  id        String   @id @default(cuid())
  category  String   // FAQ, PROGRAM, ORGANIZATION, OTHER
  question  String
  answer    String
  keywords  String?
  priority  Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =============================================
// 콘텐츠 관리 모델
// =============================================

model Notice {
  id        String   @id @default(cuid())
  title     String
  content   String
  isPinned  Boolean  @default(false)
  isPublic  Boolean  @default(true)
  views     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlogPost {
  id          String   @id @default(cuid())
  authorId    String
  title       String
  slug        String   @unique
  excerpt     String?
  content     String
  image       String?
  category    String?
  tags        String?
  isPublished Boolean  @default(false)
  views       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

// =============================================
// CMS 모델
// =============================================

model PageContent {
  id          String   @id @default(cuid())
  parentId    String?  // 부모 페이지 ID (null = 최상위)
  slug        String   @unique
  title       String
  content     String?  // HTML content
  styles      String?  // CSS styles
  components  String?  // GrapesJS JSON data
  metaTitle   String?
  metaDesc    String?
  isFolder    Boolean  @default(false)  // 폴더 여부
  order       Int      @default(0)       // 정렬 순서
  isPublished Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  parent      PageContent?  @relation("PageHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    PageContent[] @relation("PageHierarchy")
}

model Menu {
  id        String   @id @default(cuid())
  parentId  String?
  title     String
  url       String?
  target    String?  @default("_self")
  position  Int      @default(0)
  isActive  Boolean  @default(true)
  location  String?  // HEADER, FOOTER
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SiteSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String?
  type      String?  // TEXT, NUMBER, BOOLEAN, JSON, IMAGE
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Banner {
  id        String    @id @default(cuid())
  title     String
  subtitle  String?
  image     String?
  link      String?
  position  String?   // HERO, SIDEBAR, POPUP
  isActive  Boolean   @default(true)
  startDate DateTime?
  endDate   DateTime?
  order     Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// =============================================
// 시스템 모델
// =============================================

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  target    String?
  targetId  String?
  details   String?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // SYSTEM, PROGRAM, PAYMENT, OTHER
  title     String
  content   String?
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailLog {
  id        String   @id @default(cuid())
  to        String
  subject   String
  content   String?
  status    String   @default("SENT") // SENT, FAILED
  error     String?
  createdAt DateTime @default(now())
}

// =============================================
// NGO 회계 시스템 모델
// =============================================

model FiscalYear {
  id        String   @id @default(cuid())
  year      Int      @unique
  startDate DateTime
  endDate   DateTime
  isCurrent Boolean  @default(false)
  isClosed  Boolean  @default(false)
  createdAt DateTime @default(now())

  budgets Budget[]
}

model FinanceAccount {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  type        String   // INCOME, EXPENSE, ASSET, LIABILITY
  category    String
  subcategory String?
  description String?
  isActive    Boolean  @default(true)
  isSystem    Boolean  @default(false)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  transactions FinanceTransaction[]
  budgetItems  BudgetItem[]
}

model Fund {
  id               String   @id @default(cuid())
  name             String
  type             String   // GENERAL, PROJECT
  description      String?
  financeProjectId String?
  balance          Int      @default(0)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())

  financeProject FinanceProject? @relation(fields: [financeProjectId], references: [id])
  transactions   FinanceTransaction[]
  budgets        Budget[]
}

model FinanceProject {
  id              String    @id @default(cuid())
  name            String
  funder          String
  contractNumber  String?
  totalBudget     Int
  startDate       DateTime
  endDate         DateTime
  status          String    @default("PLANNING") // PLANNING, ACTIVE, SETTLEMENT, CLOSED
  settlementDates String?   // JSON array
  description     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  funds       Fund[]
  budgetItems ProjectBudgetItem[]
  documents   ProjectDocument[]
}

model ProjectBudgetItem {
  id               String  @id @default(cuid())
  financeProjectId String
  category         String
  subcategory      String?
  item             String
  budget           Int
  executed         Int     @default(0)
  note             String?
  sortOrder        Int     @default(0)

  financeProject FinanceProject @relation(fields: [financeProjectId], references: [id], onDelete: Cascade)
}

model ProjectDocument {
  id               String   @id @default(cuid())
  financeProjectId String
  type             String   // CONTRACT, REPORT, SETTLEMENT, OTHER
  name             String
  fileUrl          String
  uploadedAt       DateTime @default(now())
  uploadedBy       String?

  financeProject FinanceProject @relation(fields: [financeProjectId], references: [id], onDelete: Cascade)
}

model FinanceTransaction {
  id                  String   @id @default(cuid())
  date                DateTime
  type                String   // INCOME, EXPENSE
  fundId              String
  financeAccountId    String
  amount              Int
  description         String
  vendor              String?
  paymentMethod       String?  // CASH, CARD, TRANSFER
  projectBudgetItemId String?
  receiptId           String?
  evidenceType        String?  // TAX_INVOICE, CASH_RECEIPT, CARD_SLIP, SIMPLE, NONE
  depositType         String?  // DEPOSIT_IN, DEPOSIT_RETURN, DEPOSIT_FORFEIT
  participantId       String?
  note                String?
  createdBy           String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  fund           Fund           @relation(fields: [fundId], references: [id])
  financeAccount FinanceAccount @relation(fields: [financeAccountId], references: [id])
  receipt        Receipt?       @relation(fields: [receiptId], references: [id])
}

model Receipt {
  id           String   @id @default(cuid())
  imageUrl     String
  thumbnailUrl String?
  ocrData      String?  // JSON
  ocrStatus    String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  date         DateTime?
  amount       Int?
  vendor       String?
  status       String   @default("PENDING") // PENDING, MATCHED, ARCHIVED
  uploadedBy   String?
  uploadedAt   DateTime @default(now())

  transactions FinanceTransaction[]
}

model Budget {
  id           String    @id @default(cuid())
  fundId       String
  fiscalYearId String
  status       String    @default("DRAFT") // DRAFT, APPROVED, CLOSED
  totalAmount  Int       @default(0)
  approvedAt   DateTime?
  approvedBy   String?
  createdAt    DateTime  @default(now())

  fund       Fund       @relation(fields: [fundId], references: [id])
  fiscalYear FiscalYear @relation(fields: [fiscalYearId], references: [id])
  items      BudgetItem[]
}

model BudgetItem {
  id               String @id @default(cuid())
  budgetId         String
  financeAccountId String
  amount           Int
  executed         Int    @default(0)
  note             String?

  budget         Budget         @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  financeAccount FinanceAccount @relation(fields: [financeAccountId], references: [id])
}

model FinanceDonation {
  id              String    @id @default(cuid())
  donorId         String?
  donorName       String
  donorType       String    @default("INDIVIDUAL") // INDIVIDUAL, CORPORATE
  amount          Int
  date            DateTime
  type            String    @default("ONETIME") // REGULAR, ONETIME, DESIGNATED
  designation     String?
  receiptIssued   Boolean   @default(false)
  receiptNumber   String?
  receiptIssuedAt DateTime?
  note            String?
  createdAt       DateTime  @default(now())

  donor Donor? @relation(fields: [donorId], references: [id])
}

model Donor {
  id            String    @id @default(cuid())
  name          String
  type          String    @default("INDIVIDUAL") // INDIVIDUAL, CORPORATE
  residentId    String?   // 암호화
  businessId    String?
  phone         String?
  email         String?
  address       String?
  totalDonation Int       @default(0)
  donationCount Int       @default(0)
  lastDonationAt DateTime?
  createdAt     DateTime  @default(now())

  donations FinanceDonation[]
}

// =============================================
// NGO 프로그램 관리 확장 모델
// =============================================

model ProgramApplication {
  id           String    @id @default(cuid())
  programId    String
  userId       String
  status       String    @default("PENDING") // PENDING, ACCEPTED, ADDITIONAL, REJECTED, NO_CONTACT
  appliedAt    DateTime  @default(now())
  confirmedAt  DateTime?
  cancelledAt  DateTime?
  cancelReason String?
  note         String?

  // 신청 정보
  email            String?
  hometown         String?         // 고향
  residence        String?         // 거주지역
  motivation       String? @db.Text // 신청동기
  source           String?         // 신청경로: EXISTING_MEMBER, HANA_FOUNDATION, SNS, KAKAO_GROUP, KAKAO_CHANNEL, REFERRAL
  referrer         String?         // 추천인 (source가 REFERRAL일 때)
  facePrivacy      Boolean @default(false) // 얼굴 비공개 희망
  privacyAgreed    Boolean @default(true)  // 개인정보 동의

  // 보증금 정보
  depositPaid    Boolean   @default(false)
  depositAmount  Int?
  depositPaidAt  DateTime?
  depositNote    String?

  // 독서모임용 책 조사
  bookReceiveType      String?   // PAPER, EBOOK, OWN
  ebookProvider        String?   // KYOBO, YES24, RIDI, ALADIN, OTHER
  ebookProviderOther   String?   // 기타 직접입력
  bookSurveyCompletedAt DateTime?

  // 알림 발송 이력
  acceptNotifiedAt  DateTime?
  rejectNotifiedAt  DateTime?
  depositNotifiedAt DateTime?

  // 커스텀 필드
  customFields String? @db.Text // JSON

  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@unique([programId, userId])
}

model ProgramGallery {
  id         String   @id @default(cuid())
  programId  String
  imageUrl   String
  caption    String?
  sortOrder  Int      @default(0)
  uploadedAt DateTime @default(now())

  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)
}

model DepositSetting {
  id              String    @id @default(cuid())
  programId       String    @unique
  isEnabled       Boolean   @default(true)
  totalSessions   Int
  depositAmount   Int
  conditionType   String    // ATTENDANCE_ONLY, ATTENDANCE_AND_REPORT
  attendanceRate  Int       @default(80)
  reportRate      Int?
  status          String    @default("ACTIVE") // ACTIVE, SETTLING, SETTLED
  settledAt       DateTime?
  settledBy       String?
  totalDeposits   Int       @default(0)
  totalReturned   Int       @default(0)
  totalForfeited  Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)
}

model ProgramParticipant {
  id                    String    @id @default(cuid())
  programId             String
  userId                String
  status                String    @default("ACTIVE") // ACTIVE, DROPPED, COMPLETED
  joinedAt              DateTime  @default(now())
  depositAmount         Int       @default(0)
  depositPaidAt         DateTime?
  depositStatus         String    @default("NONE") // NONE, UNPAID, PAID, RETURNED, FORFEITED, CARRIED
  finalAttendanceRate   Float?
  finalReportRate       Float?
  returnAmount          Int?
  forfeitAmount         Int?
  returnMethod          String?   // TRANSFER, CARRY_OVER, CASH
  settledAt             DateTime?
  settleNote            String?
  depositTransactionId  String?
  returnTransactionId   String?
  forfeitTransactionId  String?

  program     Program               @relation(fields: [programId], references: [id], onDelete: Cascade)
  user        User                  @relation(fields: [userId], references: [id])
  attendances ProgramAttendance[]
  reports     ProgramReport[]

  @@unique([programId, userId])
}

model ProgramSession {
  id             String    @id @default(cuid())
  programId      String
  sessionNo      Int
  date           DateTime
  startTime      String?
  endTime        String?
  title          String?
  bookTitle      String?
  bookRange      String?
  location       String?
  description    String?
  qrCode         String?   @unique
  qrExpiresAt    DateTime?
  reportDeadline DateTime?
  status         String    @default("SCHEDULED") // SCHEDULED, ONGOING, COMPLETED, CANCELLED
  createdAt      DateTime  @default(now())

  program     Program             @relation(fields: [programId], references: [id], onDelete: Cascade)
  attendances ProgramAttendance[]
  reports     ProgramReport[]

  @@unique([programId, sessionNo])
}

model ProgramAttendance {
  id            String    @id @default(cuid())
  sessionId     String
  participantId String
  status        String    @default("ABSENT") // PRESENT, ABSENT, LATE, EXCUSED
  checkedAt     DateTime?
  checkMethod   String?   // QR, MANUAL
  note          String?

  session     ProgramSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  participant ProgramParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([sessionId, participantId])
}

model ProgramReport {
  id            String    @id @default(cuid())
  sessionId     String
  participantId String
  userId        String
  programId     String
  title         String
  content       String
  charCount     Int       @default(0)
  photoUrl      String?
  question      String?
  status        String    @default("DRAFT") // DRAFT, SUBMITTED
  submittedAt   DateTime?
  visibility    String    @default("PARTICIPANTS") // PARTICIPANTS, PUBLIC
  viewCount     Int       @default(0)
  likeCount     Int       @default(0)
  commentCount  Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  session     ProgramSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  participant ProgramParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  user        User               @relation(fields: [userId], references: [id])
  program     Program            @relation(fields: [programId], references: [id], onDelete: Cascade)
  comments    ReportComment[]
  likes       ReportLike[]

  @@unique([sessionId, participantId])
}

model ReportComment {
  id        String   @id @default(cuid())
  reportId  String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  report ProgramReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  user   User          @relation(fields: [userId], references: [id])
}

model ReportLike {
  id        String   @id @default(cuid())
  reportId  String
  userId    String
  createdAt DateTime @default(now())

  report ProgramReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  user   User          @relation(fields: [userId], references: [id])

  @@unique([reportId, userId])
}

// =============================================
// 프로그램 신청 시스템 확장 모델
// =============================================

model ProgramLike {
  id        String   @id @default(cuid())
  programId String
  userId    String
  createdAt DateTime @default(now())

  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([programId, userId])
}

model ApplicationForm {
  id          String   @id @default(cuid())
  name        String
  description String?
  isDefault   Boolean  @default(false)
  fields      String   @db.Text // JSON array of field definitions
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  programs Program[]
}

model NotificationTemplate {
  id        String   @id @default(cuid())
  type      String   // ACCEPT, ADDITIONAL, REJECT, DEPOSIT, BOOK_SURVEY, REMINDER, NEW_PROGRAM
  name      String
  subject   String
  content   String   @db.Text
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NotificationLog {
  id             String    @id @default(cuid())
  type           String
  recipientId    String?
  recipientEmail String?
  recipientPhone String?
  subject        String
  content        String    @db.Text
  channel        String    // EMAIL, SMS, KAKAO, PUSH
  status         String    @default("PENDING") // PENDING, SENT, FAILED
  sentAt         DateTime?
  errorMessage   String?
  createdAt      DateTime  @default(now())
}

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  description String?
  updatedAt   DateTime @updatedAt
}

// =============================================
// 관심사(Interest) 시스템 모델
// =============================================

// 관심 키워드 (통계 및 관리용)
model InterestKeyword {
  id                String    @id @default(cuid())
  keyword           String    @unique
  category          String?   // 카테고리 분류
  totalCount        Int       @default(0) // 전체 언급 횟수
  monthlyCount      Int       @default(0) // 이번달 언급 횟수
  likeCount         Int       @default(0) // 공감 수
  relatedProgramIds String?   // JSON array - 관련 프로그램 ID들
  isFixed           Boolean   @default(false) // 고정 키워드 여부
  isRecommended     Boolean   @default(false) // 추천 키워드 여부
  isHidden          Boolean   @default(false) // 숨김 처리 여부
  lastUsedAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  interests   Interest[]
  keywordLikes InterestKeywordLike[]
  alerts      InterestAlert[]
}

// 개별 관심사 입력
model Interest {
  id         String   @id @default(cuid())
  keywordId  String
  content    String?  // 추가 내용 (선택)
  userId     String?  // 회원인 경우
  sessionId  String?  // 비회원 세션 ID
  nickname   String?  // 표시할 닉네임 (익명, 닉네임, 실명)
  visibility String   @default("ANONYMOUS") // ANONYMOUS, NICKNAME, MEMBER
  likeCount  Int      @default(0) // 공감 수
  ipHash     String?  // IP 해시 (중복 방지)
  createdAt  DateTime @default(now())

  keyword InterestKeyword @relation(fields: [keywordId], references: [id], onDelete: Cascade)
  user    User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  likes   InterestLike[]
}

// 관심사 좋아요 (개별 관심사에 대한)
model InterestLike {
  id         String   @id @default(cuid())
  interestId String
  userId     String?
  sessionId  String?
  createdAt  DateTime @default(now())

  interest Interest @relation(fields: [interestId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([interestId, userId])
  @@unique([interestId, sessionId])
}

// 키워드 공감 (키워드 자체에 대한)
model InterestKeywordLike {
  id        String   @id @default(cuid())
  keywordId String
  userId    String?
  sessionId String?
  createdAt DateTime @default(now())

  keyword InterestKeyword @relation(fields: [keywordId], references: [id], onDelete: Cascade)
  user    User?           @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([keywordId, userId])
  @@unique([keywordId, sessionId])
}

// 알림 신청
model InterestAlert {
  id                String    @id @default(cuid())
  keywordId         String
  userId            String?
  email             String
  name              String?
  isActive          Boolean   @default(true)
  notifiedAt        DateTime?
  notifiedProgramId String?
  createdAt         DateTime  @default(now())

  keyword InterestKeyword @relation(fields: [keywordId], references: [id], onDelete: Cascade)
  user    User?           @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([keywordId, email])
}

// 관심사 시스템 설정
model InterestSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  description String?
  updatedAt   DateTime @updatedAt
}

// =============================================
// 협조요청 시스템
// =============================================

// 협조요청 섹션 (메인 페이지 표시용)
model CooperationSection {
  id         String   @id @default(cuid())
  order      Int      @default(0)
  title      String
  content    String   @db.Text
  image      String?
  imageAlt   String?
  buttonText String   @default("요청하기")
  buttonLink String
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// 자문요청
model ConsultingRequest {
  id           String   @id @default(cuid())
  startDate    DateTime
  endDate      DateTime
  duration     Int      // 시간
  method       String   // OFFLINE, ONLINE
  fee          Int?     // 만원 단위
  requirements String   @db.Text
  organization String
  contactName  String
  email        String
  phone        String
  attachment   String?
  status       String   @default("PENDING") // PENDING, REVIEWING, MATCHED, COMPLETED, REJECTED
  adminNote    String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// 강사요청
model LecturerRequest {
  id              String   @id @default(cuid())
  topic           String
  schedules       Json     // [{date, startTime, endTime}]
  method          String   // OFFLINE, ONLINE
  requirements    String   @db.Text
  fee             String?
  organization    String
  contactName     String
  contactTitle    String?
  email           String
  phone           String
  attachment      String?
  feeAgreement    Boolean  @default(false)
  matchedExpertId String?
  status          String   @default("PENDING") // PENDING, REVIEWING, MATCHED, COMPLETED, REJECTED
  adminNote       String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// 설문·인터뷰 요청
model SurveyRequest {
  id             String   @id @default(cuid())
  startDate      DateTime
  endDate        DateTime
  questionCount  Int
  estimatedTime  Int      // 분 단위
  serviceFee     Int?     // 만원 단위
  participantFee Int?     // 만원 단위
  requirements   String   @db.Text
  requesterType  String   // INDIVIDUAL, ORGANIZATION
  requesterName  String
  email          String
  phone          String
  attachment     String?
  status         String   @default("PENDING") // PENDING, REVIEWING, IN_PROGRESS, COMPLETED, REJECTED
  adminNote      String?  @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// =============================================
// 리서치랩 전문가/강사 풀 시스템
// =============================================

// 전문가 프로필 (확장된 모델 - 기존 Expert 대체)
model ExpertProfile {
  id                String    @id @default(cuid())
  userId            String?   @unique // 회원 연동 (선택)

  // 기본 정보
  name              String
  nameEn            String?
  photo             String?
  title             String?   // 직함
  organization      String?   // 소속

  // 연락처
  email             String
  phone             String?

  // 출신 정보
  origin            String    @default("NORTH") // NORTH, SOUTH (기존 호환)
  originCategory    String?   // DEFECTOR, MARRIAGE_IMMIGRANT, MIGRANT_WORKER, INTERNATIONAL_STUDENT, REFUGEE, OVERSEAS_KOREAN, MULTICULTURAL_CHILD, NATURALIZED, KOREAN
  originCountry     String?   // 출신 국가 코드
  arrivalYear       Int?      // 입국년도 (범용)
  defectionYear     Int?      // 탈북년도 (북한이탈주민)
  settlementYear    Int?      // 정착년도
  hometown          String?   // 고향/출신지역

  // 전문 대상 그룹
  targetExpertise   String?   @db.Text // JSON array: 어떤 이주민 그룹에 전문인지

  // 학력/경력
  education         String?   @db.Text // JSON array
  career            String?   @db.Text // JSON array
  certifications    String?   @db.Text // JSON array

  // 전문 분야
  categories        String?   // JSON array of category IDs
  specialties       String?   @db.Text // 세부 전문 분야
  keywords          String?   // 검색 키워드 (쉼표 구분)

  // 강연 정보
  lectureTopics     String?   @db.Text // 강연 가능 주제
  lectureAreas      String?   // 강연 가능 지역 (JSON array)
  lectureFeeMin     Int?      // 최소 강연료 (만원)
  lectureFeeMax     Int?      // 최대 강연료 (만원)
  lectureNote       String?   @db.Text // 강연 관련 비고

  // 자문/컨설팅
  consultingAreas   String?   @db.Text // 자문 가능 분야
  consultingFee     Int?      // 자문료 (시간당, 만원)

  // 연구 참여
  researchInterests String?   @db.Text // 관심 연구 분야
  surveyAvailable   Boolean   @default(true)  // 설문 참여 가능
  interviewAvailable Boolean  @default(true)  // 인터뷰 참여 가능

  // 소개
  bio               String?   @db.Text
  portfolio         String?   // 포트폴리오 URL
  sns               String?   // SNS JSON {linkedin, instagram, etc}

  // 실적 통계
  lectureCount      Int       @default(0)
  consultingCount   Int       @default(0)
  researchCount     Int       @default(0)
  rating            Float?    // 평균 평점

  // 상태
  isVerified        Boolean   @default(false) // 인증 여부
  isPublic          Boolean   @default(false) // 공개 여부
  isActive          Boolean   @default(true)
  viewCount         Int       @default(0)

  // 관리
  verifiedAt        DateTime?
  verifiedBy        String?
  adminNote         String?   @db.Text

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  lectureMatches    LectureMatch[]
  researchParticipations ResearchParticipation[]
}

// 강연 매칭 (강사 요청과 전문가 연결)
model LectureMatch {
  id               String    @id @default(cuid())
  requestId        String?   // LecturerRequest ID (메인 사이트 요청)
  expertId         String

  // 요청 정보 (직접 요청인 경우)
  topic            String?
  date             DateTime?
  duration         Int?      // 시간
  method           String?   // OFFLINE, ONLINE
  location         String?
  fee              Int?      // 만원

  // 요청자 정보
  requesterOrg     String?
  requesterName    String?
  requesterEmail   String?
  requesterPhone   String?

  status           String    @default("PENDING") // PENDING, ACCEPTED, REJECTED, COMPLETED, CANCELLED
  rating           Int?      // 1-5
  feedback         String?   @db.Text

  // 정산
  actualFee        Int?
  isPaid           Boolean   @default(false)
  paidAt           DateTime?

  adminNote        String?   @db.Text
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  expert           ExpertProfile @relation(fields: [expertId], references: [id], onDelete: Cascade)
}

// 리서치랩 설문조사
model LabSurvey {
  id               String    @id @default(cuid())
  title            String
  description      String?   @db.Text
  type             String    @default("SURVEY") // SURVEY, INTERVIEW

  // 모집 정보
  targetCount      Int       @default(10) // 목표 참가자 수
  currentCount     Int       @default(0)  // 현재 참가자 수

  // 참가 자격
  targetOrigin     String?   // NORTH, SOUTH, ANY (기존 호환)
  targetCategories String?   @db.Text // JSON array: 대상 이주민 카테고리들
  targetCountries  String?   @db.Text // JSON array: 대상 출신 국가들
  targetAgeMin     Int?
  targetAgeMax     Int?
  targetGender     String?   // MALE, FEMALE, ANY
  targetConditions String?   @db.Text // 기타 참가 조건

  // 설문 정보
  questionCount    Int?
  estimatedTime    Int?      // 분 단위
  questions        String?   @db.Text // JSON - 설문 문항 (간단한 설문용)
  externalUrl      String?   // 외부 설문 URL (구글폼 등)

  // 사례비
  rewardType       String    @default("CASH") // CASH, POINT, GIFT
  rewardAmount     Int?      // 사례비 금액
  rewardNote       String?

  // 기간
  startDate        DateTime
  endDate          DateTime

  // 요청자 정보 (외부 요청인 경우)
  isExternal       Boolean   @default(false)
  requesterName    String?
  requesterOrg     String?
  requesterEmail   String?
  requesterPhone   String?

  // 상태
  status           String    @default("DRAFT") // DRAFT, RECRUITING, CLOSED, COMPLETED
  isPublic         Boolean   @default(true)

  adminNote        String?   @db.Text
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  participations   ResearchParticipation[]
}

// 연구 참여 기록
model ResearchParticipation {
  id               String    @id @default(cuid())
  surveyId         String
  expertId         String?   // 등록된 전문가인 경우
  userId           String?   // 일반 회원인 경우

  // 참가자 정보 (비회원인 경우)
  name             String?
  email            String?
  phone            String?
  origin           String?   // NORTH, SOUTH (기존 호환)
  originCategory   String?   // 이주민 카테고리
  originCountry    String?   // 출신 국가

  status           String    @default("APPLIED") // APPLIED, APPROVED, COMPLETED, CANCELLED, REJECTED

  // 응답 데이터
  responses        String?   @db.Text // JSON - 설문 응답 (내부 설문용)
  completedAt      DateTime?

  // 사례비 지급
  rewardStatus     String    @default("PENDING") // PENDING, PAID, CANCELLED
  rewardAmount     Int?
  paidAt           DateTime?

  note             String?   @db.Text
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  survey           LabSurvey      @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  expert           ExpertProfile? @relation(fields: [expertId], references: [id], onDelete: SetNull)
}

// 전문가 카테고리
model ExpertCategory {
  id               String    @id @default(cuid())
  name             String    @unique
  nameEn           String?
  description      String?
  icon             String?
  color            String?
  sortOrder        Int       @default(0)
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
}

// 연구 동향 (크롤링 데이터)
model ResearchTrend {
  id               String    @id @default(cuid())
  title            String
  authors          String?
  source           String    // 출처 (RISS, DBPIA, KCI 등)
  sourceUrl        String?
  publishedDate    DateTime?
  abstract         String?   @db.Text
  keywords         String?
  category         String?
  views            Int       @default(0)
  isActive         Boolean   @default(true)
  crawledAt        DateTime  @default(now())
  createdAt        DateTime  @default(now())
}
